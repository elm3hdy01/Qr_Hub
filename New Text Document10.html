<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Hub - منصة إنشاء الرموز QR المتطورة</title>

<!-- CDNs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --sub:#94a3b8; --ring:#243145;
    --brand:#22d3ee; --accent:#f59e0b; --ok:#22c55e; --bad:#ef4444;
    --transition: all 0.3s ease;
  }
  [data-theme="light"]{
    --bg:#f4f6fb; --card:#ffffff; --text:#0b1220; --sub:#475569; --ring:#e5e7eb;
    --brand:#0ea5e9; --accent:#b45309; --ok:#16a34a; --bad:#dc2626;
  }
  *{box-sizing:border-box; margin:0; padding:0;}
  body{
    margin:0; font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    background:var(--bg); color:var(--text); transition: var(--transition);
    min-height: 100vh; display: flex; flex-direction: column;
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(12px);
    background:linear-gradient(180deg, rgba(0,0,0,.25), transparent);
    border-bottom:1px solid var(--ring);
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor: pointer;}
  .mark {
    width: 36px; height: 36px; border-radius: 10px; 
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    display: flex; align-items: center; justify-content: center;
    position: relative; overflow: hidden;
  }
  .mark::before {
    content: ""; position: absolute; width: 60%; height: 60%;
    background: white; border-radius: 4px; 
    box-shadow: 0 0 0 3px #6a11cb, 0 0 0 5px #2575fc;
  }
  .mark::after {
    content: ""; position: absolute; width: 15%; height: 15%;
    background: #2575fc; border-radius: 50%; bottom: 5px; right: 5px;
  }
  .brand b{font-size:18px; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
  .user{opacity:.9; display: flex; align-items: center; gap: 8px;}
  .user-thanks {font-size: 12px; color: var(--brand); font-weight: bold;}
  nav.tabs{
    display:flex; gap:6px; overflow:auto; padding:8px 12px; border-top:1px solid var(--ring);
  }
  nav.tabs button{
    flex:0 0 auto; padding:10px 12px; border:1px solid var(--ring); background:var(--card);
    color:var(--text); border-radius:12px; cursor:pointer; font-weight:700; transition: var(--transition);
  }
  nav.tabs button.active{outline:2px solid var(--brand); box-shadow:0 0 0 3px rgba(34,211,238,.15)}
  nav.tabs button:hover{transform: translateY(-2px);}
  .wrap{max-width:1100px; margin-inline:auto; padding:16px; flex: 1;}
  .page{display:none; animation:fade .3s ease}
  .page.active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.2); margin-bottom:14px; transition: var(--transition);
  }
  .card:hover {transform: translateY(-3px);}
  .row{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px}
  @media (max-width:900px){ .row{grid-template-columns:1fr} }
  label.small{font-size:12px; color:var(--sub); margin:6px 2px; display:block}
  input[type="text"], input[type="url"], input[type="password"], input[type="number"], input[type="color"], textarea, select{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--ring); background:transparent; color:var(--text);
    outline:none; transition: var(--transition);
  }
  input:focus, textarea:focus, select:focus {border-color: var(--brand);}
  textarea{min-height:80px; resize:vertical}
  .btn{appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; transition: var(--transition);}
  .btn:hover {transform: translateY(-2px); opacity: 0.9;}
  .btn.primary{background:var(--brand); color:#081018}
  .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--ring)}
  .btn.bad{background:var(--bad); color:#fff}
  .btn.ok{background:var(--ok); color:#fff}
  .stack{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .hint{font-size:12px; color:var(--sub)}
  .center{display:flex; align-items:center; justify-content:center}
  .qrbox{position:relative; display:inline-block; padding:12px; background:#fff; border-radius:16px; margin: 10px 0;}
  .qrbox .logoOverlay{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border-radius:50%; border:3px solid #fff; width:22%; aspect-ratio:1; object-fit:cover}
  .grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px}
  @media (max-width:800px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width:520px){ .grid{grid-template-columns: 1fr; } }
  .thumb{background:#fff; border-radius:12px; padding:8px; border:1px solid var(--ring); transition: var(--transition);}
  .thumb:hover {transform: scale(1.02);}
  .thumb img{width:100%; height:auto; display:block; border-radius:8px}
  .flex{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid var(--ring); font-size:12px}
  .alert{padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:rgba(255,255,255,.04)}
  .login-wrap{max-width:420px; margin:40px auto}
  .footer{opacity:.7; text-align:center; font-size:12px; padding:20px; margin-top: auto;}
  
  /* New styles */
  .loading {display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;}
  @keyframes spin {to {transform: rotate(360deg);}}
  .toast {
    position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: var(--card); color: var(--text);
    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center;
    gap: 10px; transform: translateY(100px); opacity: 0; transition: var(--transition);
  }
  .toast.show {transform: translateY(0); opacity: 1;}
  .toast.success {border-left: 4px solid var(--ok);}
  .toast.error {border-left: 4px solid var(--bad);}
  .toast.info {border-left: 4px solid var(--brand);}
  .modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal.show {opacity: 1; pointer-events: all;}
  .modal-content {
    background: var(--card); padding: 20px; border-radius: 12px; max-width: 400px; width: 90%;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .modal-actions {display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;}
  .social-share {display: flex; gap: 10px; margin-top: 15px;}
  .social-btn {
    display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;
    border-radius: 50%; background: var(--bg); color: var(--text); border: 1px solid var(--ring);
    cursor: pointer; transition: var(--transition);
  }
  .social-btn:hover {transform: translateY(-3px); background: var(--brand); color: #000;}
  .input-error {border-color: var(--bad) !important;}
  .error-text {color: var(--bad); font-size: 12px; margin-top: 5px;}
  .tab-content {display: none;}
  .tab-content.active {display: block; animation: fade 0.3s;}
  .qr-type-selector {display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
  .qr-type-btn {
    padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--ring);
    cursor: pointer; transition: var(--transition);
  }
  .qr-type-btn.active {background: var(--brand); color: #000; border-color: var(--brand);}
  .wifi-fields, .contact-fields, .multilink-fields {display: none;}
  .form-group {margin-bottom: 15px;}
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;
  }
  .stat-card {
    background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--ring);
  }
  .stat-number {
    font-size: 2rem; font-weight: bold; color: var(--brand); margin: 10px 0;
  }
  .stat-label {
    font-size: 0.9rem; color: var(--sub);
  }
  .main-layout {
    display: grid; grid-template-columns: 1fr 350px; gap: 20px;
  }
  @media (max-width: 900px) {
    .main-layout {grid-template-columns: 1fr;}
  }
  .section-title {
    display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 10px;
    border-bottom: 1px solid var(--ring);
  }
  .section-title i {color: var(--brand);}
  .quick-actions {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;
  }
  .lib-item {
    display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px;
    background: var(--card); margin-bottom: 10px; border: 1px solid var(--ring);
  }
  .lib-item img {width: 50px; height: 50px; border-radius: 8px;}
  .lib-info {flex: 1;}
  .lib-actions {display: flex; gap: 5px;}
  .empty-state {
    text-align: center; padding: 30px; color: var(--sub);
  }
  .empty-state i {font-size: 3rem; margin-bottom: 15px; opacity: 0.5;}
  .contact-list {
    list-style: none; padding: 0; margin: 20px 0;
  }
  .contact-list li {
    display: flex; align-items: center; gap: 15px; padding: 12px; 
    border-radius: 10px; background: var(--card); margin-bottom: 10px;
    border: 1px solid var(--ring);
  }
  .contact-list li i {
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: var(--bg); border-radius: 50%; font-size: 18px;
  }
  .contact-list a {
    color: var(--brand); text-decoration: none; transition: var(--transition);
  }
  .contact-list a:hover {
    text-decoration: underline; color: var(--text);
  }
  .setting-item {
    display: flex; justify-content: space-between; align-items: center; 
    padding: 15px; border-bottom: 1px solid var(--ring);
  }
  .setting-item:last-child {
    border-bottom: none;
  }
  .toggle-switch {
    position: relative; display: inline-block; width: 50px; height: 24px;
  }
  .toggle-switch input {
    opacity: 0; width: 0; height: 0;
  }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--ring); transition: .4s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
  }
  input:checked + .slider {
    background-color: var(--brand);
  }
  input:checked + .slider:before {
    transform: translateX(26px);
  }
  
  /* Link Hub Styles */
  .link-item {
    display: flex; align-items: center; gap: 12px; padding: 12px; 
    border-radius: 12px; background: var(--card); margin-bottom: 10px;
    border: 1px solid var(--ring); transition: var(--transition);
  }
  .link-item:hover {
    transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .link-icon {
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: var(--bg); border-radius: 10px; font-size: 18px; flex-shrink: 0;
  }
  .link-info {flex: 1;}
  .link-url {
    font-size: 12px; color: var(--sub); overflow: hidden; 
    text-overflow: ellipsis; white-space: nowrap; max-width: 200px;
  }
  .link-actions {display: flex; gap: 5px;}
  .drag-handle {
    cursor: move; color: var(--sub); padding: 5px;
  }
  .theme-options {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;
  }
  .theme-option {
    padding: 15px; border-radius: 12px; text-align: center; cursor: pointer;
    border: 2px solid var(--ring); transition: var(--transition);
  }
  .theme-option:hover {
    transform: translateY(-3px);
  }
  .theme-option.active {
    border-color: var(--brand); box-shadow: 0 0 0 3px rgba(34,211,238,.15);
  }
  .theme-dark {background: #0b1220; color: #e5e7eb;}
  .theme-light {background: #f4f6fb; color: #0b1220;}
  .theme-auto {background: linear-gradient(135deg, #0b1220 50%, #f4f6fb 50%); color: #0b1220;}
  
  /* Social Platform Selector */
  .platform-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin: 15px 0;
  }
  .platform-item {
    display: flex; flex-direction: column; align-items: center; padding: 10px;
    border-radius: 10px; border: 1px solid var(--ring); cursor: pointer; transition: var(--transition);
  }
  .platform-item:hover {
    transform: translateY(-3px); background: var(--bg);
  }
  .platform-item.active {
    border-color: var(--brand); background: var(--bg);
  }
  .platform-icon {
    font-size: 24px; margin-bottom: 5px;
  }
  
  /* Language Switcher */
  .lang-switcher {
    display: flex; gap: 5px; margin-left: 10px;
  }
  .lang-btn {
    padding: 5px 10px; border-radius: 5px; background: var(--bg); 
    border: 1px solid var(--ring); cursor: pointer;
  }
  .lang-btn.active {
    background: var(--brand); color: #000;
  }
  
  /* Admin Dashboard */
  .admin-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;
  }
  .admin-stat {
    background: var(--card); padding: 20px; border-radius: 12px; text-align: center;
    border: 1px solid var(--ring);
  }
  .admin-stat-number {
    font-size: 2rem; font-weight: bold; color: var(--brand); margin: 10px 0;
  }
  
  /* Multi-link QR Styles */
  .profile-preview {
    display: flex; flex-direction: column; align-items: center; margin: 20px 0;
  }
  .profile-avatar {
    width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--brand);
  }
  .profile-name {
    font-size: 1.5rem; font-weight: bold; margin: 10px 0 5px;
  }
  .profile-bio {
    color: var(--sub); text-align: center; max-width: 300px;
  }
  
  /* Profile Page Styles */
  .profile-header {
    text-align: center; padding: 20px; margin-bottom: 20px;
  }
  .profile-avatar-large {
    width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--brand);
    margin: 0 auto 15px;
  }
  .profile-social-links {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;
  }
  .profile-social-item {
    display: flex; align-items: center; gap: 15px; padding: 15px; 
    border-radius: 12px; background: var(--card); border: 1px solid var(--ring);
    transition: var(--transition);
  }
  .profile-social-item:hover {
    transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .profile-social-icon {
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: var(--bg); border-radius: 10px; font-size: 20px; flex-shrink: 0;
  }
  
  /* Why Choose Us Section */
  .features-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;
  }
  .feature-card {
    padding: 20px; border-radius: 12px; background: var(--card); border: 1px solid var(--ring);
    text-align: center; transition: var(--transition);
  }
  .feature-card:hover {
    transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  }
  .feature-icon {
    font-size: 2.5rem; margin-bottom: 15px; color: var(--brand);
  }
</style>
</head>
<body data-theme="dark" data-lang="ar">
  <header>
    <div class="topbar wrap">
      <div class="brand" onclick="openPage('dashboard')">
        <div class="mark"></div>
        <b>QR Hub</b>
      </div>
      <div class="stack">
        <div class="lang-switcher">
          <button class="lang-btn active" data-lang="ar">عربي</button>
          <button class="lang-btn" data-lang="en">English</button>
        </div>
        <span class="pill user" id="userBadge">غير مسجل <span class="user-thanks" id="userThanks"></span></span>
        <button class="btn ghost" id="toggleTheme" title="تبديل الوضع">🌙/🌞</button>
        <button class="btn ghost" id="logoutBtn"><i class="fa fa-right-from-bracket"></i> خروج</button>
      </div>
    </div>
    <nav class="tabs wrap" id="tabs">
      <button data-page="login" class="active"><i class="fa fa-user"></i> <span data-translate="login">الدخول</span></button>
      <button data-page="dashboard"><i class="fa fa-table-columns"></i> <span data-translate="dashboard">الرئيسية</span></button>
      <button data-page="qr"><i class="fa fa-qrcode"></i> <span data-translate="qr">QR</span></button>
      <button data-page="links"><i class="fa fa-link"></i> <span data-translate="linkHub">Link Hub</span></button>
      <button data-page="profile" id="profileTab" style="display:none"><i class="fa fa-user-circle"></i> <span data-translate="profile">الملف الشخصي</span></button>
      <button data-page="analytics"><i class="fa fa-chart-line"></i> <span data-translate="analytics">الإحصائيات</span></button>
      <button data-page="about"><i class="fa fa-users"></i> <span data-translate="about">من نحن</span></button>
      <button data-page="settings"><i class="fa fa-gear"></i> <span data-translate="settings">الإعدادات</span></button>
      <button data-page="admin" style="display:none" id="adminTab"><i class="fa fa-crown"></i> <span data-translate="admin">المشرف</span></button>
    </nav>
  </header>

  <main class="wrap">
    <!-- LOGIN -->
    <section class="page card active" id="login">
      <div class="login-wrap">
        <h2 data-translate="login">تسجيل الدخول</h2>
        <p class="hint" data-translate="loginHint">دخّل أي اسم وباسورد للتجربة. يتم الحفظ محليًا على جهازك.</p>
        <div class="form-group">
          <label class="small" data-translate="username">اسم المستخدم</label>
          <input id="l_user" type="text" placeholder="Your name">
        </div>
        <div class="form-group">
          <label class="small" data-translate="password">كلمة المرور</label>
          <input id="l_pass" type="password" placeholder="•••••••">
        </div>
        <div class="stack" style="margin-top:10px">
          <button class="btn primary" id="loginBtn" data-translate="login">دخول</button>
          <button class="btn ghost" id="guestBtn" data-translate="guestLogin">دخول كضيف</button>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section class="page card" id="dashboard">
      <h2 data-translate="dashboard">لوحة التحكم</h2>
      
      <div class="row">
        <div class="card">
          <div class="section-title">
            <i class="fa fa-history"></i>
            <h3 data-translate="recentActivity">آخر نشاط</h3>
          </div>
          <div class="alert" id="lastActivity" data-translate="noActivity">لا يوجد نشاط حتى الآن.</div>
        </div>
        
        <div class="card">
          <div class="section-title">
            <i class="fa fa-info-circle"></i>
            <h3>نظرة سريعة على QR Hub</h3>
          </div>
          <p>منصة متكاملة لإنشاء وإدارة رموز QR باحترافية. أنشئ روابطك، شبكات الواي فاي، بطاقات التواصل، وصفحات روابط متعددة بسهولة.</p>
          <div class="stack" style="margin-top:15px">
            <button class="btn primary" data-jump="qr"><i class="fa fa-qrcode"></i> إنشاء QR</button>
            <button class="btn ghost" data-jump="about"><i class="fa fa-info"></i> المزيد</button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="section-title">
          <i class="fa fa-star"></i>
          <h3>لماذا تختار QR Hub؟</h3>
        </div>
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon"><i class="fa fa-bolt"></i></div>
            <h4>سريع وسهل</h4>
            <p>واجهة مستخدم بسيطة تتيح لك إنشاء رموز QR في ثوانٍ</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon"><i class="fa fa-shield-alt"></i></div>
            <h4>خصوصية كاملة</h4>
            <p>بياناتك تبقى على جهازك ولا نشاركها مع أي أحد</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon"><i class="fa fa-palette"></i></div>
            <h4>تخصيص متقدم</h4>
            <p>اختر الألوان، الأحجام، وأضف شعارك الخاص</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon"><i class="fa fa-link"></i></div>
            <h4>روابط متعددة</h4>
            <p>أنشئ صفحة شخصية تحتوي على جميع روابطك</p>
          </div>
        </div>
      </div>
    </section>

    <!-- QR PAGE -->
    <section class="page card" id="qr">
      <h2 data-translate="qrGenerator">منشئ QR</h2>
      
      <div class="qr-type-selector">
        <div class="qr-type-btn active" data-type="url" data-translate="link">رابط</div>
        <div class="qr-type-btn" data-type="wifi" data-translate="wifi">شبكة WiFi</div>
        <div class="qr-type-btn" data-type="contact" data-translate="contact">جهة اتصال</div>
        <div class="qr-type-btn" data-type="multilink" data-translate="multilink">روابط متعددة</div>
      </div>
      
      <div class="tab-content active" id="url-fields">
        <div class="row">
          <div>
            <label class="small" data-translate="textOrLink">النص/الرابط</label>
            <input id="qrText" type="url" placeholder="https://example.com أو أي نص">
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="wifi-fields">
        <div class="row">
          <div>
            <label class="small" data-translate="wifiSSID">اسم الشبكة (SSID)</label>
            <input id="wifi-ssid" type="text" placeholder="اسم الشبكة">
          </div>
          <div>
            <label class="small" data-translate="password">كلمة المرور</label>
            <input id="wifi-password" type="password" placeholder="كلمة مرور WiFi">
          </div>
          <div>
            <label class="small" data-translate="encryptionType">نوع التشفير</label>
            <select id="wifi-encryption">
              <option value="WPA">WPA/WPA2</option>
              <option value="WEP">WEP</option>
              <option value="nopass" data-translate="none">لا يوجد</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="contact-fields">
        <div class="row">
          <div>
            <label class="small" data-translate="name">الاسم</label>
            <input id="contact-name" type="text" placeholder="الاسم الكامل">
          </div>
          <div>
            <label class="small" data-translate="phone">الهاتف</label>
            <input id="contact-phone" type="text" placeholder="رقم الهاتف">
          </div>
          <div>
            <label class="small" data-translate="email">البريد الإلكتروني</label>
            <input id="contact-email" type="email" placeholder="example@mail.com">
          </div>
          <div>
            <label class="small" data-translate="address">العنوان</label>
            <input id="contact-address" type="text" placeholder="العنوان">
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="multilink-fields">
        <div class="alert">
          <i class="fa fa-info-circle"></i> تم نقل خيار الروابط المتعددة إلى قسم <strong>Link Hub</strong> لإنشاء صفحة شخصية متكاملة.
        </div>
        <div class="center" style="margin:20px 0">
          <button class="btn primary" data-jump="links">الذهاب إلى Link Hub</button>
        </div>
      </div>
      
      <div class="row">
        <div>
          <label class="small" data-translate="qrSize">حجم الكود</label>
          <select id="qrSize">
            <option value="192">192</option>
            <option value="256" selected>256</option>
            <option value="384">384</option>
            <option value="512">512</option>
          </select>
        </div>
        <div>
          <label class="small" data-translate="dotsColor">لون النقاط</label>
          <input id="qrDark" type="color" value="#000000">
        </div>
        <div>
          <label class="small" data-translate="bgColor">لون الخلفية</label>
          <input id="qrLight" type="color" value="#ffffff">
        </div>
        <div>
          <label class="small" data-translate="eccLevel">مستوى التصحيح (ECC)</label>
          <select id="qrECC">
            <option value="L">L</option>
            <option value="M" selected>M</option>
            <option value="Q">Q</option>
            <option value="H">H</option>
          </select>
        </div>
        <div>
          <label class="small" data-translate="uploadLogo">رفع لوجو داخل الكود (اختياري)</label>
          <input id="qrLogo" type="file" accept="image/*">
        </div>
      </div>

      <div class="stack" style="margin:10px 0">
        <button class="btn primary" id="genQR" data-translate="generate">توليد</button>
        <button class="btn ghost" id="dlPNG" data-translate="downloadPNG">تحميل PNG</button>
        <button class="btn ghost" id="dlPDF" data-translate="downloadPDF">تحميل PDF</button>
        <button class="btn ok"    id="saveQR" data-translate="saveToLibrary">حفظ في المكتبة</button>
        <button class="btn ghost" id="shareQR" data-translate="share">مشاركة</button>
        <button class="btn bad"   id="clearQR" data-translate="clear">مسح</button>
      </div>

      <div class="center">
        <div id="loadingIndicator" class="loading" style="display:none; margin: 20px;"></div>
        <div class="qrbox">
          <div id="qrcode"></div>
          <img id="qrLogoOverlay" class="logoOverlay" style="display:none" alt="">
        </div>
      </div>
    </section>

    <!-- LINK HUB PAGE -->
    <section class="page card" id="links">
      <h2 data-translate="linkHub">Link Hub - الصفحة الشخصية</h2>
      <p class="hint" data-translate="linkHubDesc">أنشئ صفحتك الشخصية التي تحتوي على جميع روابطك وقم بمشاركتها برمز QR واحد.</p>
      
      <div class="card">
        <h3 data-translate="profileInfo">معلومات الملف الشخصي</h3>
        <div class="row">
          <div>
            <label class="small" data-translate="profileName">اسم الملف الشخصي</label>
            <input id="profile-name" type="text" placeholder="اسمك أو اسم علامتك التجارية">
          </div>
          <div>
            <label class="small" data-translate="profileBio">نبذة عنك</label>
            <textarea id="profile-bio" placeholder="اكتب نبذة مختصرة عنك"></textarea>
          </div>
          <div>
            <label class="small" data-translate="profilePhoto">صورة شخصية</label>
            <input id="profile-photo" type="file" accept="image/*">
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3 data-translate="addNewLink">إضافة رابط جديد</h3>
        <div class="row">
          <div>
            <label class="small" data-translate="platform">المنصة</label>
            <select id="linkPlatform">
              <option value="website" data-translate="website">موقع ويب</option>
              <option value="facebook">Facebook</option>
              <option value="instagram">Instagram</option>
              <option value="twitter">Twitter</option>
              <option value="youtube">YouTube</option>
              <option value="linkedin">LinkedIn</option>
              <option value="tiktok">TikTok</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="telegram">Telegram</option>
              <option value="snapchat">Snapchat</option>
              <option value="pinterest">Pinterest</option>
              <option value="custom" data-translate="custom">مخصص</option>
            </select>
          </div>
          <div>
            <label class="small" data-translate="linkTitle">عنوان الرابط</label>
            <input id="linkTitle" type="text" placeholder="مثال: حسابي على إنستجرام">
          </div>
          <div>
            <label class="small" data-translate="linkUrl">الرابط</label>
            <input id="linkUrl" type="url" placeholder="https://example.com">
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <button class="btn primary" id="addLinkBtn" data-translate="addLink">إضافة رابط</button>
        </div>
      </div>
      
      <div class="card">
        <h3 data-translate="myLinks">روابطي</h3>
        <p class="hint" data-translate="dragToReorder">اسحب الروابط لتغيير ترتيبها. سيظهر هذا الترتيب في صفحة الروابط الخاصة بك.</p>
        <div id="linksList"></div>
      </div>
      
      <div class="card">
        <h3 data-translate="linkHubQR">Link Hub QR</h3>
        <p class="hint" data-translate="linkHubQRDesc">أنشئ QR Code واحد يوجه إلى صفحتك الشخصية التي تحتوي على جميع روابطك.</p>
        <div class="stack">
          <button class="btn primary" id="genLinkHubQR" data-translate="generateLinkQR">إنشاء QR للروابط</button>
          <button class="btn ghost" id="previewLinkHub" data-translate="preview">معاينة صفحة الروابط</button>
          <button class="btn ok" id="saveProfileQR" data-translate="saveProfileQR">حفظ QR الصفحة</button>
        </div>
        <div class="center" id="linkHubQrContainer" style="margin-top:20px; display:none">
          <div class="qrbox">
            <div id="linkHubQrCode"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE PAGE -->
    <section class="page card" id="profile">
      <div class="profile-header">
        <img src="" class="profile-avatar-large" id="profileAvatarLarge" alt="Profile" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
        <h2 id="profileNameDisplay">اسم المستخدم</h2>
        <p id="profileBioDisplay" class="hint">نبذة عن المستخدم</p>
      </div>
      
      <div class="card">
        <h3>روابطي</h3>
        <div id="profileLinksList" class="profile-social-links">
          <!-- سيتم ملؤها بالروابط -->
        </div>
      </div>
      
      <div class="center" style="margin-top:30px">
        <div class="qrbox">
          <div id="profileQrCode"></div>
        </div>
        <p class="hint" style="margin-top:15px">QR Code خاص بصفحتك الشخصية</p>
      </div>
      
      <div class="center" style="margin-top:30px">
        <button class="btn primary" onclick="openPage('links')"><i class="fa fa-edit"></i> تعديل الصفحة الشخصية</button>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section class="page card" id="analytics">
      <h2 data-translate="analytics">لوحة الإحصائيات</h2>
      <div class="row">
        <div class="card">
          <div class="flex">
            <div>👁️ <span data-translate="views">المشاهدات</span></div><b id="st_views">0</b>
          </div>
          <div class="flex">
            <div>🧩 <span data-translate="qrGenerations">توليد QR</span></div><b id="st_generations">0</b>
          </div>
          <div class="flex">
            <div>⬇️ <span data-translate="downloads">تنزيلات</span></div><b id="st_downloads">0</b>
          </div>
          <div class="flex">
            <div>📚 <span data-translate="saves">حفظ في المكتبة</span></div><b id="st_saves">0</b>
          </div>
        </div>
        <div class="card">
          <canvas id="chart" height="150"></canvas>
        </div>
      </div>
      
      <div class="card">
        <h3>📚 <span data-translate="qrLibrary">مكتبة الـ QR المحفوظة</span></h3>
        <div class="grid" id="qrLibrary"></div>
        <div class="stack" style="margin-top:8px">
          <button class="btn bad" id="clearLib" data-translate="clearLibrary">مسح المكتبة</button>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="page card" id="about">
      <h2 data-translate="about">من نحن</h2>
      <div class="alert">
        <p data-translate="aboutDesc1">
          إحنا فريق صغير بدأ المشروع ده بشغف وخطوات كتير وتجارب أكتر،
          هدفنا نسهّل على الناس تنظيم هويتهم الرقمية: كود واحد يوصل لكل روابطك،
          ولوحة إحصائيات تديك رؤية واضحة.
        </p>
        <p data-translate="aboutDesc2">
          تعبنا في التصميم والتجربة علشان نوصل لتجربة بسيطة، سريعة، وشياكة تشبه التطبيقات الكبيرة.
          كل ده بيشتغل بدون سيرفر — احترامًا لخصوصيتك وسهولة الاستخدام.
        </p>
        <p data-translate="aboutDesc3">
          تقدر تستفيد من الموقع في مشاركة هويتك ولينكاتك، وتتبع نشاطك — كل ده من جهازك.
        </p>
        
        <h3 data-translate="whyChooseUs">لماذا تختار QR Hub؟</h3>
        <ul>
          <li data-translate="feature1">✅ لا حاجة لتسجيل الدخول - كل بياناتك محفوظة على جهازك</li>
          <li data-translate="feature2">✅ واجهة مستبدية سهلة الاستخدام باللغة العربية</li>
          <li data-translate="feature3">✅ دعم كامل لجميع أنواع QR Codes</li>
          <li data-translate="feature4">✅ إحصائيات مفصلة عن استخدامك للبرنامج</li>
          <li data-translate="feature5">✅ إمكانية حفظ وتنظيم جميع أكواد QR الخاصة بك</li>
          <li>✅ إنشاء صفحة شخصية متكاملة تحتوي على جميع روابطك</li>
        </ul>
        
        <h3 data-translate="contact">طرق التواصل:</h3>
        <ul class="contact-list">
          <li>
            <i class="fas fa-envelope" style="color: #ea4335;"></i>
            <div>
              <strong data-translate="email">البريد الإلكتروني</strong><br>
              <a href="mailto:elm3hdy1@gmail.com">elm3hdy1@gmail.com</a>
            </div>
          </li>
          <li>
            <i class="fab fa-whatsapp" style="color: #25d366;"></i>
            <div>
              <strong data-translate="whatsapp">واتساب</strong><br>
              <a href="https://wa.me/201116506278" target="_blank">+201116506278</a>
            </div>
          </li>
          <li>
            <i class="fab fa-facebook" style="color: #1877f2;"></i>
            <div>
              <strong>فيسبوك</strong><br>
              <a href="https://www.facebook.com/share/19kKUZcBDK/" target="_blank">facebook.com/QRHub</a>
            </div>
          </li>
          <li>
            <i class="fab fa-instagram" style="color: #e4405f;"></i>
            <div>
              <strong>إنستجرام</strong><br>
              <a href="https://instagram.com/elm3hdy_01" target="_blank">instagram.com/elm3hdy_01</a>
            </div>
          </li>
        </ul>
        
        <div class="center" style="margin-top: 20px;">
          <button class="btn primary" onclick="openPage('qr')" data-translate="startCreating">ابدأ إنشاء QR الآن</button>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="page card" id="settings">
      <h2 data-translate="settings">الإعدادات</h2>
      <div class="row">
        <div class="card">
          <h3 data-translate="appearance">المظهر</h3>
          <div class="theme-options">
            <div class="theme-option theme-dark active" data-theme="dark">
              <i class="fas fa-moon"></i>
              <div data-translate="dark">داكن</div>
            </div>
            <div class="theme-option theme-light" data-theme="light">
              <i class="fas fa-sun"></i>
              <div data-translate="light">فاتح</div>
            </div>
            <div class="theme-option theme-auto" data-theme="auto">
              <i class="fas fa-adjust"></i>
              <div data-translate="auto">تلقائي</div>
            </div>
          </div>
          <p class="hint" data-translate="themeHint">يتم حفظ الاختيار تلقائيًا.</p>
        </div>
        <div class="card">
          <h3 data-translate="data">البيانات</h3>
          <div class="stack">
            <button class="btn bad" id="wipeAll" data-translate="wipeAllData">مسح كل البيانات</button>
          </div>
          <p class="hint" data-translate="dataHint">يشمل تسجيل الدخول، الإحصائيات، المكتبة، والمحفظة.</p>
        </div>
      </div>
      
      <div class="card">
        <h3 data-translate="appSettings">إعدادات التطبيق</h3>
        
        <div class="setting-item">
          <div>
            <strong data-translate="autoCopy">النسخ التلقائي للرابط</strong>
            <p class="hint" data-translate="autoCopyHint">نسخ الرابط تلقائيًا عند إنشاء QR</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoCopy">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong data-translate="autoSave">الحفظ التلقائي</strong>
            <p class="hint" data-translate="autoSaveHint">حفظ QR تلقائيًا في المكتبة بعد الإنشاء</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoSave">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong data-translate="notifications">إشعارات النشاط</strong>
            <p class="hint" data-translate="notificationsHint">عرض إشعارات عند إكمال المهام</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="showNotifications" checked>
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong data-translate="imageQuality">جودة الصور</strong>
            <p class="hint" data-translate="imageQualityHint">جودة صور QR عند التحميل</p>
          </div>
          <select id="imageQuality">
            <option value="high" data-translate="high">عالية</option>
            <option value="medium" selected data-translate="medium">متوسطة</option>
            <option value="low" data-translate="low">منخفضة</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <h3 data-translate="appInfo">معلومات التطبيق</h3>
        <div class="setting-item">
          <strong data-translate="version">الإصدار</strong>
          <span class="hint">2.0.0</span>
        </div>
        <div class="setting-item">
          <strong data-translate="updateDate">تاريخ التحديث</strong>
          <span class="hint">يناير 2025</span>
        </div>
        <div class="setting-item">
          <strong data-translate="developer">المطور</strong>
          <span class="hint">Ahmed Elmahdy</span>
        </div>
        <div class="setting-item">
          <strong data-translate="contactSupport">تواصل مع الدعم</strong>
          <span class="hint">
            <a href="mailto:elm3hdy1@gmail.com">elm3hdy1@gmail.com</a>
          </span>
        </div>
        <div class="setting-item">
          <strong data-translate="complaints">الشكاوي</strong>
          <span class="hint">
            <a href="https://wa.me/201116506278">+201116506278</a>
          </span>
        </div>
      </div>
    </section>

    <!-- ADMIN DASHBOARD -->
    <section class="page card" id="admin">
      <h2><i class="fa fa-crown"></i> لوحة تحكم المشرف</h2>
      
      <div class="admin-stats">
        <div class="admin-stat">
          <div class="stat-label">👥 المستخدمين المسجلين</div>
          <div class="admin-stat-number" id="adminUserCount">0</div>
        </div>
        <div class="admin-stat">
          <div class="stat-label">📊 إجمالي مرات الدخول</div>
          <div class="admin-stat-number" id="adminLoginCount">0</div>
        </div>
        <div class="admin-stat">
          <div class="stat-label">🧩 إجمالي أكواد QR</div>
          <div class="admin-stat-number" id="adminQrCount">0</div>
        </div>
        <div class="admin-stat">
          <div class="stat-label">📈 نشاط الموقع</div>
          <div class="admin-stat-number" id="adminActivity">0</div>
        </div>
      </div>
      
      <div class="row">
        <div class="card">
          <h3>آخر المستخدمين المسجلين</h3>
          <div id="adminRecentUsers" class="alert">
            لا يوجد مستخدمين مسجلين بعد.
          </div>
        </div>
        <div class="card">
          <h3>إحصائيات الاستخدام</h3>
          <canvas id="adminChart" height="150"></canvas>
        </div>
      </div>
      
      <div class="card">
        <h3>إدارة الموقع</h3>
        <div class="stack">
          <button class="btn primary" id="exportData">تصدير بيانات الموقع</button>
          <button class="btn bad" id="resetAllData">إعادة ضبط جميع البيانات</button>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">© 2025 QR Hub — <span data-translate="footer">يعمل محليًا بدون سيرفر</span> | تم التطوير بواسطة <strong>Ahmed Elmahdy</strong></div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content">
      <h3 id="modalTitle">تأكيد الإجراء</h3>
      <p id="modalMessage">هل أنت متأكد من أنك تريد متابعة هذا الإجراء؟</p>
      <div class="modal-actions">
        <button class="btn ghost" id="modalCancel">إلغاء</button>
        <button class="btn primary" id="modalConfirm">تأكيد</button>
      </div>
    </div>
  </div>

  <!-- Link Hub Preview Modal -->
  <div class="modal" id="linkHubPreviewModal">
    <div class="modal-content" style="max-width: 500px;">
      <h3>معاينة صفحة الروابط</h3>
      <div id="linkHubPreview" style="max-height: 400px; overflow-y: auto;">
        <!-- Preview content will be inserted here -->
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="closePreview">إغلاق</button>
      </div>
    </div>
  </div>

<script>
  // ==== Helpers & Storage ====
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => [...root.querySelectorAll(s)];
  const SKEY = 'qrhub_state_v4';
  const ADMIN_USER = 'owner@elm3hdy';
  const ADMIN_PASS = 'Abdalleh1@#';
  
  const defaultState = {
    theme: 'dark',
    language: 'ar',
    user: null, // {name, passHash, userId, isAdmin, loginCount}
    stats: { views: 0, generations: 0, downloads: 0, saves: 0 },
    lastActivity: '',
    qrLib: [], // [{id, dataURL, text, createdAt, name}]
    links: [], // [{id, title, url, icon, order}]
    profile: { // Profile data for Link Hub
      name: '',
      bio: '',
      avatar: '',
      profileQR: ''
    },
    settings: {
      autoCopy: false,
      autoSave: false,
      showNotifications: true,
      imageQuality: 'medium',
      focusMode: false,
      animations: true
    },
    // Admin data
    admin: {
      totalLogins: 0,
      totalUsers: 0,
      userLogins: {},
      recentUsers: []
    }
  };
  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(SKEY);
      return raw ? {...defaultState, ...JSON.parse(raw)} : structuredClone(defaultState);
    }catch{ return structuredClone(defaultState); }
  }
  
  function saveState(){
    localStorage.setItem(SKEY, JSON.stringify(state));
    updateBadges();
    updateDashboard();
    updateSettingsUI();
    renderLinksList();
    updateLanguage();
  }
  
  function logActivity(msg){
    state.lastActivity = `${new Date().toLocaleString()} — ${msg}`;
    $('#lastActivity').textContent = state.lastActivity || translate('noActivity');
    saveState();
  }

  // Translation system
  const translations = {
    ar: {
      login: "الدخول",
      dashboard: "الرئيسية",
      qr: "QR",
      linkHub: "Link Hub",
      analytics: "الإحصائيات",
      about: "من نحن",
      settings: "الإعدادات",
      admin: "المشرف",
      profile: "الملف الشخصي",
      loginHint: "دخّل أي اسم وباسورد للتجربة. يتم الحفظ محليًا على جهازك.",
      username: "اسم المستخدم",
      password: "كلمة المرور",
      guestLogin: "دخول كضيف",
      views: "المشاهدات",
      qrGenerations: "توليد QR",
      downloads: "تنزيلات",
      saves: "حفظ في المكتبة",
      quickActions: "إجراءات سريعة",
      createQR: "إنشاء QR",
      recentActivity: "آخر نشاط",
      noActivity: "لا يوجد نشاط حتى الآن.",
      recentSavedQR: "أحدث QR محفوظ",
      noSavedQR: "لا توجد أكواد محفوظة بعد",
      createFirstQR: "إنشاء أول QR",
      qrGenerator: "منشئ QR",
      link: "رابط",
      wifi: "شبكة WiFi",
      contact: "جهة اتصال",
      multilink: "روابط متعددة",
      textOrLink: "النص/الرابط",
      wifiSSID: "اسم الشبكة (SSID)",
      encryptionType: "نوع التشفير",
      none: "لا يوجد",
      name: "الاسم",
      phone: "الهاتف",
      email: "البريد الإلكتروني",
      address: "العنوان",
      profileName: "اسم الملف الشخصي",
      profileBio: "نبذة عنك",
      profilePhoto: "صورة شخصية",
      addLinks: "إضافة روابط",
      website: "موقع ويب",
      custom: "مخصص",
      addAnotherLink: "إضافة رابط آخر",
      qrSize: "حجم الكود",
      dotsColor: "لون النقاط",
      bgColor: "لون الخلفية",
      eccLevel: "مستوى التصحيح (ECC)",
      uploadLogo: "رفع لوجو داخل الكود (اختياري)",
      generate: "توليد",
      downloadPNG: "تحميل PNG",
      downloadPDF: "تحميل PDF",
      saveToLibrary: "حفظ في المكتبة",
      share: "مشاركة",
      clear: "مسح",
      linkHubDesc: "أضف وادار جميع روابطك في مكان واحد وأنشئ QR واحد يوجه إلى صفحة تحتوي على جميع روابطك.",
      platform: "المنصة",
      linkTitle: "عنوان الرابط",
      linkUrl: "الرابط",
      addLink: "إضافة رابط",
      myLinks: "روابطي",
      dragToReorder: "اسحب الروابط لتغيير ترتيبها. سيظهر هذا الترتيب في صفحة الروابط الخاصة بك.",
      linkHubQR: "Link Hub QR",
      linkHubQRDesc: "أنشئ QR Code واحد يوجه إلى صفحة تحتوي على جميع روابطك.",
      generateLinkQR: "إنشاء QR للروابط",
      preview: "معاينة",
      saveProfileQR: "حفظ QR الصفحة",
      qrLibrary: "مكتبة الـ QR المحفوظة",
      clearLibrary: "مسح المكتبة",
      aboutDesc1: "إحنا فريق صغير بدأ المشروع ده بشغف وخطوات كتير وتجارب أكتر، هدفنا نسهّل على الناس تنظيم هويتهم الرقمية: كود واحد يوصل لكل روابطك، ومحفظة شخصية تحفظ مستنداتك محليًا، ولوحة إحصائيات تديك رؤية واضحة.",
      aboutDesc2: "تعبنا في التصميم والتجربة علشان نوصل لتجربة بسيطة، سريعة، وشياكة تشبه التطبيقات الكبيرة. كل ده بيشتغل بدون سيرفر — احترامًا لخصوصيتك وسهولة الاستخدام.",
      aboutDesc3: "تقدر تستفيد من الموقع في مشاركة هويتك ولينكاتك، تسهيل الدفع، وتتبع نشاطك — كل ده من جهازك.",
      whyChooseUs: "لماذا تختار QR Hub؟",
      feature1: "✅ لا حاجة لتسجيل الدخول - كل بياناتك محفوظة على جهازك",
      feature2: "✅ واجهة مستبدية سهلة الاستخدام باللغة العربية",
      feature3: "✅ دعم كامل لجميع أنواع QR Codes",
      feature4: "✅ إحصائيات مفصلة عن استخدامك للبرنامج",
      feature5: "✅ إمكانية حفظ وتنظيم جميع أكواد QR الخاصة بك",
      contact: "طرق التواصل:",
      whatsapp: "واتساب",
      privacyPolicy: "سياسة الخصوصية",
      privacyDesc: "نحن لا نجمع أي بيانات شخصية. جميع المعلومات التي تدخلها في التطبيق تبقى على جهازك فقط ولا يتم إرسالها إلى أي سيرفر خارجي. هذا التطبيق مصمم ليعمل بالكامل على متصفحك دون الحاجة إلى اتصال بالإنترنت بعد التحميل الأولي.",
      startCreating: "ابدأ إنشاء QR الآن",
      appearance: "المظهر",
      dark: "داكن",
      light: "فاتح",
      auto: "تلقائي",
      themeHint: "يتم حفظ الاختيار تلقائيًا.",
      data: "البيانات",
      wipeAllData: "مسح كل البيانات",
      dataHint: "يشمل تسجيل الدخول، الإحصائيات، المكتبة، والمحفظة.",
      appSettings: "إعدادات التطبيق",
      autoCopy: "النسخ التلقائي للرابط",
      autoCopyHint: "نسخ الرابط تلقائيًا عند إنشاء QR",
      autoSave: "الحفظ التلقائي",
      autoSaveHint: "حفظ QR تلقائيًا في المكتبة بعد الإنشاء",
      notifications: "إشعارات النشاط",
      notificationsHint: "عرض إشعارات عند إكمال المهام",
      imageQuality: "جودة الصور",
      imageQualityHint: "جودة صور QR عند التحميل",
      high: "عالية",
      medium: "متوسطة",
      low: "منخفضة",
      focusMode: "وضع التركيز",
      focusModeHint: "إخفاء العناصر غير الضرورية لوضع العمل",
      animations: "الرسوم المتحركة",
      animationsHint: "تمكين التأثيرات والتحريك في الواجهة",
      appInfo: "معلومات التطبيق",
      version: "الإصدار",
      updateDate: "تاريخ التحديث",
      developer: "المطور",
      contactSupport: "تواصل مع الدعم",
      complaints: "الشكاوي",
      footer: "يعمل محليًا بدون سيرفر",
      profileInfo: "معلومات الملف الشخصي",
      enterLinkDetails: "أدخل عنوانًا ورابطًا صالحًا",
      linkAdded: "تم إضافة الرابط بنجاح",
      linkAddedActivity: "إضافة رابط جديد: ",
      editLinkTitle: "عدل عنوان الرابط:",
      editLinkUrl: "عدل الرابط:",
      linkUpdated: "تم تعديل الرابط",
      confirmDeleteLink: "هل أنت متأكد من حذف الرابط",
      linkDeleted: "تم حذف الرابط",
      addLinksFirst: "أضف روابط أولاً قبل إنشاء QR",
      linkQRGenerated: "تم إنشاء QR للروابط",
      linkQRGeneratedActivity: "إنشاء QR لصفحة الروابط",
      linkHubPreview: "معاينة صفحة الروابط",
      linksOpenNewWindow: "سيتم فتح الروابط في نافذة جديدة عند النقر عليها",
      noLinksYet: "لا توجد روابط بعد",
      addFirstLinkHint: "أضف روابطك الأولى باستخدام النموذج أعلاه",
      linksReordered: "تم تحديث ترتيب الروابط",
      loginFirst: "سجل الدخول أولًا",
      welcome: "مرحبًا",
      notRegistered: "غير مسجل",
      enterCredentials: "أدخل الاسم وكلمة المرور",
      loginActivity: "تسجيل دخول",
      guestLoginActivity: "دخول كضيف",
      guestLoginSuccess: "دخلت كضيف",
      confirmLogout: "تأكيد الخروج",
      confirmLogoutMessage: "هل أنت متأكد من أنك تريد تسجيل الخروج؟",
      logoutSuccess: "تم تسجيل الخروج",
      enterTextOrLink: "اكتب نصًا أو رابطًا أولًا",
      enterSSID: "أدخل اسم الشبكة",
      enterContactInfo: "أدخل معلومات التواصل على الأقل",
      enterProfileName: "أدخل اسم الملف الشخصي",
      addAtLeastOneLink: "أضف رابطًا واحدًا على الأقل",
      generateQRFirst: "اعمِل QR الأول",
      pngDownloaded: "تحميل PNG",
      pdfDownloaded: "تحميل PDF",
      downloadSuccess: "تم التحميل بنجاح",
      shareSuccess: "تمت المشاركة بنجاح",
      shareCancelled: "تم إلغاء المشاركة",
      shareNotSupported: "المتصفح لا يدعم Web Share للملفات — استخدم تحميل PNG بدلًا من ذلك.",
      myQRCode: "كود QR الخاص بي",
      enterQRName: "أدخل اسمًا للـ QR (اختياري):",
      qrSaved: "حفظ QR في المكتبة",
      saveSuccess: "تم الحفظ بنجاح",
      libraryEmpty: "المكتبة فارغة بالفعل",
      clearLibraryConfirm: "مسح المكتبة",
      clearLibraryMessage: "هل أنت متأكد من أنك تريد مسح كل المكتبة؟ لا يمكن التراجع عن هذا الإجراء.",
      libraryCleared: "تم مسح المكتبة",
      download: "تنزيل",
      edit: "تعديل",
      delete: "حذف",
      enterNewName: "أدخل الاسم الجديد:",
      editSuccess: "تم التعديل",
      deleteQRConfirm: "حذف QR",
      deleteQRMessage: "هل أنت متأكد من أنك تريد حذف هذا الـ QR؟",
      deleteSuccess: "تم الحذف",
      viewAll: "عرض الكل",
      noTitle: "بدون عنوان",
      createdWithQRHub: "تم إنشاء هذه الصفحة باستخدام QR Hub",
      wipeAllDataMessage: "هل أنت متأكد من أنك تريد مسح كل بيانات QR Hub على هذا المتصفح؟ لا يمكن التراجع عن هذا الإجراء.",
      wipeAllDataSuccess: "تم مسح كل البيانات ✅",
      settingsSaved: "تم حفظ الإعدادات",
      summary: "ملخص",
      qrGenerated: "توليد QR",
      qrGeneratedSuccess: "تم إنشاء QR بنجاح",
      qrCleared: "تم مسح الـ QR",
      linkCopied: "تم نسخ الرابط إلى الحافظة"
    },
    en: {
      login: "Login",
      dashboard: "Dashboard",
      qr: "QR",
      linkHub: "Link Hub",
      analytics: "Analytics",
      about: "About",
      settings: "Settings",
      admin: "Admin",
      profile: "Profile",
      loginHint: "Enter any name and password for testing. Data is saved locally on your device.",
      username: "Username",
      password: "Password",
      guestLogin: "Login as Guest",
      views: "Views",
      qrGenerations: "QR Generations",
      downloads: "Downloads",
      saves: "Saves to Library",
      quickActions: "Quick Actions",
      createQR: "Create QR",
      recentActivity: "Recent Activity",
      noActivity: "No activity yet.",
      recentSavedQR: "Recent Saved QR",
      noSavedQR: "No saved codes yet",
      createFirstQR: "Create First QR",
      qrGenerator: "QR Generator",
      link: "Link",
      wifi: "WiFi",
      contact: "Contact",
      multilink: "Multi Links",
      textOrLink: "Text/Link",
      wifiSSID: "Network Name (SSID)",
      encryptionType: "Encryption Type",
      none: "None",
      name: "Name",
      phone: "Phone",
      email: "Email",
      address: "Address",
      profileName: "Profile Name",
      profileBio: "Profile Bio",
      profilePhoto: "Profile Photo",
      addLinks: "Add Links",
      website: "Website",
      custom: "Custom",
      addAnotherLink: "Add Another Link",
      qrSize: "QR Size",
      dotsColor: "Dots Color",
      bgColor: "Background Color",
      eccLevel: "ECC Level",
      uploadLogo: "Upload Logo (Optional)",
      generate: "Generate",
      downloadPNG: "Download PNG",
      downloadPDF: "Download PDF",
      saveToLibrary: "Save to Library",
      share: "Share",
      clear: "Clear",
      linkHubDesc: "Add and manage all your links in one place and create a single QR code that directs to a page containing all your links.",
      platform: "Platform",
      linkTitle: "Link Title",
      linkUrl: "Link URL",
      addLink: "Add Link",
      myLinks: "My Links",
      dragToReorder: "Drag links to reorder them. This order will appear on your links page.",
      linkHubQR: "Link Hub QR",
      linkHubQRDesc: "Create a QR Code that directs to a page containing all your links.",
      generateLinkQR: "Generate Links QR",
      preview: "Preview",
      saveProfileQR: "Save Profile QR",
      qrLibrary: "Saved QR Library",
      clearLibrary: "Clear Library",
      aboutDesc1: "We are a small team that started this project with passion, many steps and more experiments. Our goal is to make it easier for people to organize their digital identity: one code for all your links, a personal wallet to store your documents locally, and a statistics panel that gives you clear vision.",
      aboutDesc2: "We worked hard on design and experience to reach a simple, fast, and stylish experience similar to big applications. All this works without a server - respecting your privacy and ease of use.",
      aboutDesc3: "You can benefit from the site in sharing your identity and links, facilitating payment, and tracking your activity - all from your device.",
      whyChooseUs: "Why choose QR Hub?",
      feature1: "✅ No login required - all your data is stored on your device",
      feature2: "✅ Easy-to-use Arabic interface",
      feature3: "✅ Full support for all types of QR Codes",
      feature4: "✅ Detailed statistics about your usage",
      feature5: "✅ Ability to save and organize all your QR codes",
      contact: "Contact Methods:",
      whatsapp: "WhatsApp",
      privacyPolicy: "Privacy Policy",
      privacyDesc: "We do not collect any personal data. All information you enter in the application remains on your device only and is not sent to any external server. This application is designed to work entirely on your browser without the need for an internet connection after the initial load.",
      startCreating: "Start Creating QR Now",
      appearance: "Appearance",
      dark: "Dark",
      light: "Light",
      auto: "Auto",
      themeHint: "Selection is saved automatically.",
      data: "Data",
      wipeAllData: "Wipe All Data",
      dataHint: "Includes login, statistics, library, and wallet.",
      appSettings: "App Settings",
      autoCopy: "Auto Copy Link",
      autoCopyHint: "Automatically copy the link when creating QR",
      autoSave: "Auto Save",
      autoSaveHint: "Automatically save QR to library after creation",
      notifications: "Activity Notifications",
      notificationsHint: "Show notifications when completing tasks",
      imageQuality: "Image Quality",
      imageQualityHint: "QR image quality when downloading",
      high: "High",
      medium: "Medium",
      low: "Low",
      focusMode: "Focus Mode",
      focusModeHint: "Hide unnecessary elements for work mode",
      animations: "Animations",
      animationsHint: "Enable effects and animation in the interface",
      appInfo: "App Information",
      version: "Version",
      updateDate: "Update Date",
      developer: "Developer",
      contactSupport: "Contact Support",
      complaints: "Complaints",
      footer: "Works locally without server",
      profileInfo: "Profile Information",
      enterLinkDetails: "Enter a valid title and link",
      linkAdded: "Link added successfully",
      linkAddedActivity: "Added new link: ",
      editLinkTitle: "Edit link title:",
      editLinkUrl: "Edit link URL:",
      linkUpdated: "Link updated",
      confirmDeleteLink: "Are you sure you want to delete the link",
      linkDeleted: "Link deleted",
      addLinksFirst: "Add links first before creating QR",
      linkQRGenerated: "Link QR generated successfully",
      linkQRGeneratedActivity: "Created QR for links page",
      linkHubPreview: "Links Page Preview",
      linksOpenNewWindow: "Links will open in a new window when clicked",
      noLinksYet: "No links yet",
      addFirstLinkHint: "Add your first links using the form above",
      linksReordered: "Links order updated",
      loginFirst: "Login first",
      welcome: "Welcome",
      notRegistered: "Not registered",
      enterCredentials: "Enter username and password",
      loginActivity: "Login",
      guestLoginActivity: "Guest login",
      guestLoginSuccess: "Logged in as guest",
      confirmLogout: "Confirm Logout",
      confirmLogoutMessage: "Are you sure you want to log out?",
      logoutSuccess: "Logged out successfully",
      enterTextOrLink: "Enter text or link first",
      enterSSID: "Enter network name",
      enterContactInfo: "Enter contact information at least",
      enterProfileName: "Enter profile name",
      addAtLeastOneLink: "Add at least one link",
      generateQRFirst: "Generate QR first",
      pngDownloaded: "PNG downloaded",
      pdfDownloaded: "PDF downloaded",
      downloadSuccess: "Download successful",
      shareSuccess: "Shared successfully",
      shareCancelled: "Share cancelled",
      shareNotSupported: "Browser doesn't support Web Share for files - use PNG download instead",
      myQRCode: "My QR Code",
      enterQRName: "Enter QR name (optional):",
      qrSaved: "QR saved to library",
      saveSuccess: "Saved successfully",
      libraryEmpty: "Library is already empty",
      clearLibraryConfirm: "Clear Library",
      clearLibraryMessage: "Are you sure you want to clear the entire library? This action cannot be undone.",
      libraryCleared: "Library cleared",
      download: "Download",
      edit: "Edit",
      delete: "Delete",
      enterNewName: "Enter new name:",
      editSuccess: "Edited successfully",
      deleteQRConfirm: "Delete QR",
      deleteQRMessage: "Are you sure you want to delete this QR?",
      deleteSuccess: "Deleted successfully",
      viewAll: "View All",
      noTitle: "No title",
      createdWithQRHub: "Created with QR Hub",
      wipeAllDataMessage: "Are you sure you want to delete all QR Hub data on this browser? This action cannot be undone.",
      wipeAllDataSuccess: "All data wiped ✅",
      settingsSaved: "Settings saved",
      summary: "Summary",
      qrGenerated: "QR generated",
      qrGeneratedSuccess: "QR created successfully",
      qrCleared: "QR cleared",
      linkCopied: "Link copied to clipboard"
    }
  };

  function translate(key) {
    const lang = state.language || 'ar';
    return translations[lang][key] || key;
  }

  function updateLanguage() {
    const lang = state.language;
    document.body.setAttribute('data-lang', lang);
    document.dir = lang === 'ar' ? 'rtl' : 'ltr';
    
    // Update all elements with data-translate attribute
    $$('[data-translate]').forEach(el => {
      const key = el.getAttribute('data-translate');
      el.textContent = translate(key);
    });
    
    // Update placeholders
    $('#l_user').placeholder = lang === 'ar' ? 'اسم المستخدم' : 'Username';
    $('#l_pass').placeholder = lang === 'ar' ? '•••••••' : '•••••••';
  }

  // Toast notifications
  function showToast(message, type = 'info', duration = 3000) {
    if (!state.settings.showNotifications) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-info-circle';
    if (type === 'success') icon = 'fa-check-circle';
    if (type === 'error') icon = 'fa-exclamation-circle';
    
    toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
    $('#toastContainer').appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // Confirmation modal
  function showConfirmation(title, message) {
    return new Promise((resolve) => {
      $('#modalTitle').textContent = title;
      $('#modalMessage').textContent = message;
      $('#confirmationModal').classList.add('show');
      
      $('#modalCancel').onclick = () => {
        $('#confirmationModal').classList.remove('show');
        resolve(false);
      };
      
      $('#modalConfirm').onclick = () => {
        $('#confirmationModal').classList.remove('show');
        resolve(true);
      };
    });
  }

  // Theme
  function applyTheme(t){ 
    if (t === 'auto') {
      // Check system preference
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
    } else {
      document.body.setAttribute('data-theme', t);
    }
    state.theme = t; 
    saveState(); 
  }
  
  $('#toggleTheme').addEventListener('click', ()=> {
    const currentTheme = state.theme;
    if (currentTheme === 'dark') applyTheme('light');
    else if (currentTheme === 'light') applyTheme('auto');
    else applyTheme('dark');
  });
  
  $$('#settings [data-theme]').forEach(b => b.addEventListener('click', ()=> applyTheme(b.dataset.theme)));
  $$('.theme-option').forEach(opt => {
    opt.addEventListener('click', () => {
      $$('.theme-option').forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
      applyTheme(opt.dataset.theme);
    });
  });

  // Language switcher
  $$('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.lang-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.language = btn.dataset.lang;
      saveState();
    });
  });

  // Tabs & Auth
  const tabs = $('#tabs');
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const page = btn.dataset.page;
    if(!page) return;
    if(!state.user && page!=='login'){ showToast(translate('loginFirst'), 'error'); return; }
    openPage(page);
  });
  
  function openPage(id){
    $$('#tabs button').forEach(b=> b.classList.toggle('active', b.dataset.page===id));
    $$('.page').forEach(p=> p.classList.toggle('active', p.id===id));
    if(id==='analytics') renderStats();
    if(id==='dashboard') updateDashboard();
    if(id==='settings') updateSettingsUI();
    if(id==='links') renderLinksList();
    if(id==='profile') renderProfilePage();
    if(id==='admin') renderAdminDashboard();
  }

  function updateBadges(){
    $('#userBadge').textContent = state.user ? `${translate('welcome')}، ${state.user.name}` : translate('notRegistered');
    
    // Update user thanks message
    const thanksMessages = [
      "نورتنا! 🌟",
      "أهلاً وسهلاً! 😊",
      "يسعد صباحك! ☀️",
      "الله لا يهينك! 🙏",
      "دائماً متميز! 💫",
      "أنت الأفضل! 🏆",
      "ما شاء الله! 👏",
      "الله يحفظك! 🌹"
    ];
    
    if (state.user) {
      const userHash = sha256(state.user.name).substr(0, 8);
      const messageIndex = parseInt(userHash, 16) % thanksMessages.length;
      $('#userThanks').textContent = thanksMessages[messageIndex];
    } else {
      $('#userThanks').textContent = "";
    }
    
    $('#st_views').textContent = state.stats.views;
    $('#st_generations').textContent = state.stats.generations;
    $('#st_downloads').textContent = state.stats.downloads;
    $('#st_saves').textContent = state.stats.saves;
    $('#lastActivity').textContent = state.lastActivity || translate('noActivity');
  }

  function updateDashboard() {
    $('#lastActivity').textContent = state.lastActivity || translate('noActivity');
  }

  function updateSettingsUI() {
    $('#autoCopy').checked = state.settings.autoCopy;
    $('#autoSave').checked = state.settings.autoSave;
    $('#showNotifications').checked = state.settings.showNotifications;
    $('#imageQuality').value = state.settings.imageQuality;
    $('#focusMode').checked = state.settings.focusMode;
    $('#animations').checked = state.settings.animations;
    
    // Update theme options active state
    $$('.theme-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.theme === state.theme);
    });
  }

  // Login
  $('#loginBtn').addEventListener('click', ()=>{
    const name = $('#l_user').value.trim();
    const pass = $('#l_pass').value.trim();
    if(!name || !pass) return showToast(translate('enterCredentials'), 'error');
    
    // Check if admin
    let isAdmin = false;
    if (name === ADMIN_USER && pass === ADMIN_PASS) {
      isAdmin = true;
    }
    
    // Hash password for basic security and create user ID
    const passHash = sha256(pass);
    const userId = sha256(name + Date.now()); // Unique ID for each user
    
    // Update admin stats
    if (!state.admin.userLogins[name]) {
      state.admin.userLogins[name] = 0;
      state.admin.totalUsers++;
      state.admin.recentUsers.push({
        name,
        date: new Date().toISOString(),
        isAdmin
      });
      // Keep only last 5 users
      if (state.admin.recentUsers.length > 5) {
        state.admin.recentUsers.shift();
      }
    }
    state.admin.userLogins[name]++;
    state.admin.totalLogins++;
    
    // Check if this is a new user
    state.user = {name, passHash, userId, isAdmin, loginCount: state.admin.userLogins[name]}; 
    saveState();
    logActivity(translate('loginActivity'));
    showToast(`${translate('welcome')} ${name}!`, 'success');
    
    // Show admin tab if user is admin
    if (isAdmin) {
      $('#adminTab').style.display = 'block';
    }
    
    // Show profile tab for all users
    $('#profileTab').style.display = 'block';
    
    // Hide login page and show dashboard
    $('#login').classList.remove('active');
    openPage('dashboard');
  });
  
  $('#guestBtn').addEventListener('click', ()=>{
    const guestId = 'guest_' + Date.now();
    state.user = {name:translate('guest'), passHash: '', userId: guestId, isAdmin: false}; 
    saveState();
    logActivity(translate('guestLoginActivity'));
    showToast(translate('guestLoginSuccess'), 'info');
    
    // Show profile tab for guest
    $('#profileTab').style.display = 'block';
    
    // Hide login page and show dashboard
    $('#login').classList.remove('active');
    openPage('dashboard');
  });
  
  $('#logoutBtn').addEventListener('click', async ()=>{
    const confirmed = await showConfirmation(translate('confirmLogout'), translate('confirmLogoutMessage'));
    if (confirmed) {
      state.user = null; 
      saveState(); 
      
      // Hide admin and profile tabs
      $('#adminTab').style.display = 'none';
      $('#profileTab').style.display = 'none';
      
      // Show login page and hide others
      openPage('login');
      showToast(translate('logoutSuccess'), 'info');
    }
  });

  // Increase views on first load of session
  (function incViewsOnce(){
    const k='qrhub_viewed';
    if(!sessionStorage.getItem(k)){ state.stats.views++; sessionStorage.setItem(k,'1'); saveState(); }
  })();

  // Jump buttons from dashboard
  $$('#dashboard [data-jump]').forEach(b=> b.addEventListener('click', ()=> openPage(b.dataset.jump)));

  // Apply saved theme and user
  applyTheme(state.theme);
  updateLanguage();
  updateBadges();
  if(state.user){ 
    $('#login').classList.remove('active');
    openPage('dashboard'); 
    
    // Show admin tab if user is admin
    if (state.user.isAdmin) {
      $('#adminTab').style.display = 'block';
    }
    
    // Show profile tab for all users
    $('#profileTab').style.display = 'block';
  } else { 
    openPage('login'); 
  }

  // QR Type Selector
  $$('.qr-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active button
      $$('.qr-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Show relevant fields
      $$('.tab-content').forEach(tab => tab.classList.remove('active'));
      $(`#${btn.dataset.type}-fields`).classList.add('active');
    });
  });

  // ==== QR Builder ====
  let qrcode = null;
  let logoDataURL = null;

  $('#qrLogo').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const url = await fileToDataURL(f); logoDataURL = url;
    const img = $('#qrLogoOverlay'); img.src = url; img.style.display = 'block';
  });

  $('#genQR').addEventListener('click', async ()=>{
    const type = $('.qr-type-btn.active').dataset.type;
    let text = '';
    
    // Validate and prepare text based on type
    if (type === 'url') {
      text = $('#qrText').value.trim();
      if(!text) return showToast(translate('enterTextOrLink'), 'error');
      if (!text.startsWith('http')) text = 'https://' + text;
    } 
    else if (type === 'wifi') {
      const ssid = $('#wifi-ssid').value.trim();
      const password = $('#wifi-password').value.trim();
      const encryption = $('#wifi-encryption').value;
      
      if (!ssid) return showToast(translate('enterSSID'), 'error');
      text = `WIFI:S:${ssid};T:${encryption};P:${password};;`;
    }
    else if (type === 'contact') {
      const name = $('#contact-name').value.trim();
      const phone = $('#contact-phone').value.trim();
      const email = $('#contact-email').value.trim();
      const address = $('#contact-address').value.trim();
      
      if (!name && !phone && !email) return showToast(translate('enterContactInfo'), 'error');
      
      let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
      if (name) vcard += `FN:${name}\n`;
      if (phone) vcard += `TEL:${phone}\n`;
      if (email) vcard += `EMAIL:${email}\n`;
      if (address) vcard += `ADR:;;${address};;;\n`;
      vcard += 'END:VCARD';
      
      text = vcard;
    }
    else if (type === 'multilink') {
      // Redirect to Link Hub for multilink QR
      openPage('links');
      return;
    }
    
    const size = +$('#qrSize').value;
    const dark = $('#qrDark').value; const light = $('#qrLight').value;
    const ecc = {L:QRCode.CorrectLevel.L, M:QRCode.CorrectLevel.M, Q:QRCode.CorrectLevel.Q, H:QRCode.CorrectLevel.H}[$('#qrECC').value] || QRCode.CorrectLevel.M;

    // Show loading
    $('#loadingIndicator').style.display = 'block';
    
    // Small delay to allow UI to update
    await new Promise(resolve => setTimeout(resolve, 10));
    
    $('#qrcode').innerHTML = '';
    qrcode = new QRCode($('#qrcode'), { text, width:size, height:size, colorDark:dark, colorLight:light, correctLevel:ecc });

    // Small delay for canvas render
    setTimeout(()=>{ 
      if(logoDataURL) $('#qrLogoOverlay').style.display='block'; 
      $('#loadingIndicator').style.display = 'none';
      
      // Auto-copy if enabled
      if (state.settings.autoCopy && type === 'url') {
        navigator.clipboard.writeText(text).then(() => {
          showToast(translate('linkCopied'), 'success');
        });
      }
      
      // Auto-save if enabled
      if (state.settings.autoSave) {
        setTimeout(() => {
          $('#saveQR').click();
        }, 500);
      }
    }, 200);

    state.stats.generations++; saveState();
    logActivity(translate('qrGenerated'));
    showToast(translate('qrGeneratedSuccess'), 'success');
  });

  $('#clearQR').addEventListener('click', ()=>{
    $('#qrcode').innerHTML = ''; 
    $('#qrLogoOverlay').style.display='none'; 
    logoDataURL=null; 
    $('#qrLogo').value='';
    showToast(translate('qrCleared'), 'info');
  });

  $('#dlPNG').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast(translate('generateQRFirst'), 'error');
    const a = document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download='qrcode.png'; a.click();
    state.stats.downloads++; saveState(); logActivity(translate('pngDownloaded'));
    showToast(translate('downloadSuccess'), 'success');
  });

  $('#dlPDF').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast(translate('generateQRFirst'), 'error');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text('QR Hub', 10, 10);
    const w = 160, h = 160;
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 20, 20, w, h);
    pdf.save('qrcode.pdf');
    state.stats.downloads++; saveState(); logActivity(translate('pdfDownloaded'));
    showToast(translate('downloadSuccess'), 'success');
  });

  $('#shareQR').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast(translate('generateQRFirst'), 'error');
    if(navigator.canShare && canvas.toBlob){
      canvas.toBlob(async blob=>{
        const file = new File([blob], 'qrcode.png', {type:'image/png'});
        try{
          await navigator.share({ files:[file], title:'QR Hub', text:translate('myQRCode') });
          showToast(translate('shareSuccess'), 'success');
        }catch(e){
          showToast(translate('shareCancelled'), 'info');
        }
      });
    }else{
      showToast(translate('shareNotSupported'), 'error');
    }
  });

  $('#saveQR').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast(translate('generateQRFirst'), 'error');
    
    // Ask for a name for the QR code
    const qrName = prompt(translate('enterQRName'), '');
    const text = $('#qrText').value.trim();
    const dataURL = canvas.toDataURL('image/png');
    
    state.qrLib.unshift({ 
      id: Date.now(), 
      dataURL, 
      text, 
      name: qrName || text.substring(0, 20) + (text.length > 20 ? '...' : ''),
      createdAt: new Date().toISOString() 
    });
    
    state.stats.saves++; saveState(); 
    renderLibrary();
    logActivity(translate('qrSaved'));
    showToast(translate('saveSuccess'), 'success');
  });

  $('#clearLib').addEventListener('click', async ()=>{
    if(!state.qrLib.length) return showToast(translate('libraryEmpty'), 'info');
    
    const confirmed = await showConfirmation(translate('clearLibraryConfirm'), translate('clearLibraryMessage'));
    if(confirmed){ 
      state.qrLib = []; 
      saveState(); 
      renderLibrary();
      showToast(translate('libraryCleared'), 'success');
    }
  });

  function renderLibrary(){
    const host = $('#qrLibrary'); host.innerHTML='';
    if(!state.qrLib.length){ host.innerHTML = `<div class="empty-state"><i class="fa fa-qrcode"></i><p>${translate('noSavedQR')}</p></div>`; return; }
    state.qrLib.forEach(item=>{
      const card = document.createElement('div'); card.className='thumb';
      card.innerHTML = `
        <img src="${item.dataURL}" alt="QR">
        <div class="flex" style="margin-top:8px">
          <small class="hint" title="${item.text || ''}">${item.name || (item.text || translate('noTitle')).slice(0,24)}</small>
          <div class="stack">
            <button class="btn ghost" data-dl="${item.id}">${translate('download')}</button>
            <button class="btn ghost" data-edit="${item.id}">${translate('edit')}</button>
            <button class="btn bad" data-del="${item.id}">${translate('delete')}</button>
          </div>
        </div>`;
      host.appendChild(card);
    });
  }
  
  $('#qrLibrary').addEventListener('click', async (e)=>{
    const dl = e.target.closest('[data-dl]'); 
    const edit = e.target.closest('[data-edit]');
    const del = e.target.closest('[data-del]');
    
    if(dl){
      const it = state.qrLib.find(x=> x.id == dl.dataset.dl);
      if(it){ 
        const a=document.createElement('a'); 
        a.href=it.dataURL; 
        a.download='qrcode.png'; 
        a.click(); 
        state.stats.downloads++; 
        saveState(); 
        showToast(translate('downloadSuccess'), 'success');
      }
    }
    
    if(edit){
      const it = state.qrLib.find(x=> x.id == edit.dataset.dl);
      if(it){
        const newName = prompt(translate('enterNewName'), it.name || '');
        if (newName !== null) {
          it.name = newName;
          saveState();
          renderLibrary();
          showToast(translate('editSuccess'), 'success');
        }
      }
    }
    
    if(del){
      const confirmed = await showConfirmation(translate('deleteQRConfirm'), translate('deleteQRMessage'));
      if(confirmed){
        state.qrLib = state.qrLib.filter(x=> x.id != del.dataset.del); 
        saveState(); 
        renderLibrary();
        showToast(translate('deleteSuccess'), 'success');
      }
    }
  });

  async function mergedCanvas(){
    const baseCanvas = $('#qrcode canvas');
    if(!baseCanvas) return null;
    // if no logo, return the base directly
    if(!logoDataURL){ return baseCanvas; }
    // draw onto offscreen
    const off = document.createElement('canvas');
    off.width = baseCanvas.width; off.height = baseCanvas.height;
    const ctx = off.getContext('2d');
    ctx.drawImage(baseCanvas, 0, 0);
    // draw logo
    const img = await loadImage(logoDataURL);
    const lw = Math.floor(off.width * 0.22);
    const x = Math.floor((off.width - lw)/2), y = Math.floor((off.height - lw)/2);
    // white circle behind
    ctx.save();
    ctx.beginPath(); ctx.arc(off.width/2, off.height/2, lw/2+3, 0, Math.PI*2); ctx.fillStyle = '#fff'; ctx.fill();
    ctx.closePath(); ctx.restore();
    ctx.drawImage(img, x, y, lw, lw);
    return off;
  }

  function loadImage(src){
    return new Promise((res, rej)=>{ const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src = src; });
  }
  function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); }); }

  renderLibrary();

  // ==== Link Hub Functionality ====
  function renderLinksList() {
    const container = $('#linksList');
    container.innerHTML = '';
    
    if (state.links.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fa fa-link"></i>
          <p>${translate('noLinksYet')}</p>
          <p class="hint">${translate('addFirstLinkHint')}</p>
        </div>
      `;
      return;
    }
    
    // Sort links by order
    const sortedLinks = [...state.links].sort((a, b) => a.order - b.order);
    
    sortedLinks.forEach(link => {
      const linkItem = document.createElement('div');
      linkItem.className = 'link-item';
      linkItem.dataset.id = link.id;
      linkItem.draggable = true;
      linkItem.innerHTML = `
        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
        <div class="link-icon"><i class="fab fa-${link.platform || 'globe'}"></i></div>
        <div class="link-info">
          <div>${link.title}</div>
          <div class="link-url">${link.url}</div>
        </div>
        <div class="link-actions">
          <button class="btn ghost" data-link-edit="${link.id}"><i class="fa fa-edit"></i></button>
          <button class="btn bad" data-link-delete="${link.id}"><i class="fa fa-trash"></i></button>
        </div>
      `;
      container.appendChild(linkItem);
    });
    
    // Make links draggable for reordering
    initDragAndDrop();
  }
  
  function initDragAndDrop() {
    const container = $('#linksList');
    let draggedItem = null;
    
    $$('.link-item').forEach(item => {
      // Drag start
      item.addEventListener('dragstart', (e) => {
        draggedItem = item;
        setTimeout(() => item.style.opacity = '0.5', 0);
      });
      
      // Drag end
      item.addEventListener('dragend', () => {
        $$('.link-item').forEach(i => i.style.opacity = '1');
        draggedItem = null;
      });
      
      // Drag over
      item.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
      
      // Drag enter
      item.addEventListener('dragenter', (e) => {
        e.preventDefault();
        item.style.backgroundColor = 'var(--ring)';
      });
      
      // Drag leave
      item.addEventListener('dragleave', () => {
        item.style.backgroundColor = '';
      });
      
      // Drop
      item.addEventListener('drop', (e) => {
        e.preventDefault();
        item.style.backgroundColor = '';
        
        if (draggedItem !== item) {
          // Reorder items
          const items = [...container.children];
          const fromIndex = items.indexOf(draggedItem);
          const toIndex = items.indexOf(item);
          
          if (fromIndex < toIndex) {
            container.insertBefore(draggedItem, item.nextSibling);
          } else {
            container.insertBefore(draggedItem, item);
          }
          
          // Update order in state
          const newOrder = [...container.children].map((child, index) => {
            const id = parseInt(child.dataset.id);
            const link = state.links.find(l => l.id === id);
            link.order = index;
            return link;
          });
          
          state.links = newOrder;
          saveState();
          showToast(translate('linksReordered'), 'success');
        }
      });
    });
  }
  
  // Profile photo upload
  $('#profile-photo').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const url = await fileToDataURL(file);
    state.profile.avatar = url;
    saveState();
  });

  // Add new link
  $('#addLinkBtn').addEventListener('click', () => {
    const platform = $('#linkPlatform').value;
    const title = $('#linkTitle').value.trim();
    const url = $('#linkUrl').value.trim();
    
    if (!title || !url) {
      showToast(translate('enterLinkDetails'), 'error');
      return;
    }
    
    // Validate URL
    let validUrl = url;
    if (!url.startsWith('http')) {
      validUrl = 'https://' + url;
    }
    
    const newLink = {
      id: Date.now(),
      platform,
      title,
      url: validUrl,
      order: state.links.length
    };
    
    state.links.push(newLink);
    saveState();
    renderLinksList();
    
    // Clear form
    $('#linkTitle').value = '';
    $('#linkUrl').value = '';
    $('#linkPlatform').value = 'website';
    
    showToast(translate('linkAdded'), 'success');
    logActivity(translate('linkAddedActivity') + title);
  });
  
  // Handle link actions (edit and delete)
  $('#linksList').addEventListener('click', (e) => {
    const editBtn = e.target.closest('[data-link-edit]');
    const deleteBtn = e.target.closest('[data-link-delete]');
    
    if (editBtn) {
      const linkId = parseInt(editBtn.dataset.linkEdit);
      const link = state.links.find(l => l.id === linkId);
      
      if (link) {
        const newTitle = prompt(translate('editLinkTitle'), link.title);
        if (newTitle !== null) {
          const newUrl = prompt(translate('editLinkUrl'), link.url);
          if (newUrl !== null) {
            link.title = newTitle.trim();
            link.url = newUrl.trim();
            saveState();
            renderLinksList();
            showToast(translate('linkUpdated'), 'success');
          }
        }
      }
    }
    
    if (deleteBtn) {
      const linkId = parseInt(deleteBtn.dataset.linkDelete);
      const link = state.links.find(l => l.id === linkId);
      
      if (link) {
        const confirmed = confirm(translate('confirmDeleteLink') + ` "${link.title}"?`);
        if (confirmed) {
          state.links = state.links.filter(l => l.id !== linkId);
          saveState();
          renderLinksList();
          showToast(translate('linkDeleted'), 'success');
        }
      }
    }
  });
  
  // Generate Link Hub QR
  $('#genLinkHubQR').addEventListener('click', () => {
    if (state.links.length === 0) {
      showToast(translate('addLinksFirst'), 'error');
      return;
    }
    
    // Update profile data
    state.profile.name = $('#profile-name').value.trim();
    state.profile.bio = $('#profile-bio').value.trim();
    saveState();
    
    // Create profile page HTML
    const profilePageHTML = createProfilePageHTML();
    
    // Convert to data URL
    const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(profilePageHTML)}`;
    
    // Generate QR code
    $('#linkHubQrCode').innerHTML = '';
    new QRCode($('#linkHubQrCode'), { 
      text: dataUrl, 
      width: 256, 
      height: 256,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
    
    // Save profile QR to state
    setTimeout(() => {
      const canvas = $('#linkHubQrCode canvas');
      if (canvas) {
        state.profile.profileQR = canvas.toDataURL('image/png');
        saveState();
      }
    }, 100);
    
    $('#linkHubQrContainer').style.display = 'block';
    showToast(translate('linkQRGenerated'), 'success');
    logActivity(translate('linkQRGeneratedActivity'));
  });
  
  // Save Profile QR
  $('#saveProfileQR').addEventListener('click', () => {
    if (!state.profile.profileQR) {
      showToast('أنشئ QR الصفحة أولاً', 'error');
      return;
    }
    
    const qrName = prompt('أدخل اسمًا لـ QR الصفحة الشخصية:', state.profile.name || 'الصفحة الشخصية');
    if (qrName !== null) {
      state.qrLib.unshift({ 
        id: Date.now(), 
        dataURL: state.profile.profileQR, 
        text: window.location.href, 
        name: qrName,
        createdAt: new Date().toISOString() 
      });
      
      state.stats.saves++; 
      saveState(); 
      renderLibrary();
      showToast('تم حفظ QR الصفحة الشخصية', 'success');
    }
  });
  
  // Create profile page HTML
  function createProfilePageHTML() {
    const linksHTML = state.links.map(link => `
      <div class="profile-social-item">
        <a href="${link.url}" target="_blank" style="text-decoration: none; color: #333; display: block; width: 100%;">
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 24px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 10px;">
              <i class="fab fa-${link.platform || 'globe'}"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-weight: bold;">${link.title}</div>
              <div style="font-size: 12px; color: #666;">${link.url}</div>
            </div>
          </div>
        </a>
      </div>
    `).join('');
    
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${state.profile.name} - QR Hub</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <style>
          body { 
            font-family: 'Cairo', sans-serif; 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
            text-align: center; 
            background: #f9f9f9;
            color: #333;
          }
          .profile-header { 
            margin-bottom: 30px; 
            padding: 20px; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          }
          .profile-avatar { 
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 4px solid #22d3ee; 
            margin: 0 auto 15px;
          }
          .profile-name { 
            font-size: 24px; 
            font-weight: bold; 
            margin: 0 0 10px;
            color: #333;
          }
          .profile-bio { 
            color: #666; 
            margin-bottom: 20px;
            line-height: 1.5;
          }
          .profile-social-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
          }
          .profile-social-item {
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
          }
          .profile-social-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
          }
          .footer {
            margin-top: 30px;
            color: #999;
            font-size: 12px;
          }
        </style>
      </head>
      <body>
        <div class="profile-header">
          ${state.profile.avatar ? `<img src="${state.profile.avatar}" class="profile-avatar" alt="${state.profile.name}">` : ''}
          <h1 class="profile-name">${state.profile.name}</h1>
          ${state.profile.bio ? `<p class="profile-bio">${state.profile.bio}</p>` : ''}
        </div>
        
        <div class="profile-social-links">
          ${linksHTML}
        </div>
        
        <div class="footer">
          <p>تم إنشاء هذه الصفحة باستخدام QR Hub</p>
        </div>
      </body>
      </html>
    `;
  }
  
  // Preview Link Hub page
  $('#previewLinkHub').addEventListener('click', () => {
    if (state.links.length === 0) {
      showToast(translate('addLinksFirst'), 'error');
      return;
    }
    
    // Update profile data
    state.profile.name = $('#profile-name').value.trim();
    state.profile.bio = $('#profile-bio').value.trim();
    saveState();
    
    const preview = $('#linkHubPreview');
    preview.innerHTML = '';
    
    // Create preview content
    const previewContent = document.createElement('div');
    previewContent.innerHTML = createProfilePageHTML();
    
    preview.appendChild(previewContent);
    $('#linkHubPreviewModal').classList.add('show');
  });
  
  // Close preview modal
  $('#closePreview').addEventListener('click', () => {
    $('#linkHubPreviewModal').classList.remove('show');
  });

  // Render profile page
  function renderProfilePage() {
    if (!state.user) return;
    
    // Update profile display
    $('#profileAvatarLarge').src = state.profile.avatar || 'https://via.placeholder.com/150?text=No+Image';
    $('#profileNameDisplay').textContent = state.profile.name || state.user.name;
    $('#profileBioDisplay').textContent = state.profile.bio || 'لا توجد نبذة';
    
    // Render links
    const container = $('#profileLinksList');
    container.innerHTML = '';
    
    if (state.links.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fa fa-link"></i>
          <p>لا توجد روابط بعد</p>
        </div>
      `;
    } else {
      state.links.forEach(link => {
        const linkItem = document.createElement('div');
        linkItem.className = 'profile-social-item';
        linkItem.innerHTML = `
          <a href="${link.url}" target="_blank" style="text-decoration: none; color: var(--text); display: block; width: 100%;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div class="profile-social-icon">
                <i class="fab fa-${link.platform || 'globe'}"></i>
              </div>
              <div style="flex: 1;">
                <div style="font-weight: bold;">${link.title}</div>
                <div style="font-size: 12px; color: var(--sub);">${link.url}</div>
              </div>
            </div>
          </a>
        `;
        container.appendChild(linkItem);
      });
    }
    
    // Generate profile QR code if not exists
    if (!state.profile.profileQR) {
      const profilePageHTML = createProfilePageHTML();
      const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(profilePageHTML)}`;
      
      $('#profileQrCode').innerHTML = '';
      new QRCode($('#profileQrCode'), { 
        text: dataUrl, 
        width: 200, 
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
      
      // Save profile QR to state
      setTimeout(() => {
        const canvas = $('#profileQrCode canvas');
        if (canvas) {
          state.profile.profileQR = canvas.toDataURL('image/png');
          saveState();
        }
      }, 100);
    } else {
      $('#profileQrCode').innerHTML = '';
      const img = document.createElement('img');
      img.src = state.profile.profileQR;
      img.alt = 'Profile QR Code';
      img.style.width = '200px';
      img.style.height = '200px';
      $('#profileQrCode').appendChild(img);
    }
  }

  // ==== Admin Dashboard ====
  function renderAdminDashboard() {
    $('#adminUserCount').textContent = state.admin.totalUsers;
    $('#adminLoginCount').textContent = state.admin.totalLogins;
    $('#adminQrCount').textContent = state.qrLib.length;
    $('#adminActivity').textContent = state.stats.views + state.stats.generations + state.stats.downloads + state.stats.saves;
    
    // Render recent users
    const recentUsersContainer = $('#adminRecentUsers');
    if (state.admin.recentUsers.length === 0) {
      recentUsersContainer.innerHTML = 'لا يوجد مستخدمين مسجلين بعد.';
    } else {
      recentUsersContainer.innerHTML = state.admin.recentUsers.map(user => `
        <div style="margin-bottom: 10px; padding: 10px; background: var(--bg); border-radius: 8px;">
          <div><strong>${user.name}</strong> ${user.isAdmin ? '(مدير)' : ''}</div>
          <div style="font-size: 12px; color: var(--sub);">${new Date(user.date).toLocaleString()}</div>
        </div>
      `).join('');
    }
    
    // Render admin chart
    const ctx = $('#adminChart');
    const data = {
      labels: ['مشاهدات', 'توليد QR', 'تنزيلات', 'حفظ للمكتبة'],
      datasets: [{ 
        label: 'إحصائيات الاستخدام', 
        data: [state.stats.views, state.stats.generations, state.stats.downloads, state.stats.saves],
        backgroundColor: [
          'rgba(34, 211, 238, 0.7)',
          'rgba(245, 158, 11, 0.7)',
          'rgba(34, 197, 94, 0.7)',
          'rgba(239, 68, 68, 0.7)'
        ]
      }]
    };
    
    if (window.adminChart) {
      window.adminChart.destroy();
    }
    
    window.adminChart = new Chart(ctx, { 
      type:'bar', 
      data, 
      options:{ 
        responsive:true, 
        plugins:{ legend:{display:false} },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      } 
    });
  }

  // Export data
  $('#exportData').addEventListener('click', () => {
    const dataStr = JSON.stringify(state, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'qrhub-backup.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showToast('تم تصدير بيانات الموقع', 'success');
  });

  // Reset all data
  $('#resetAllData').addEventListener('click', async () => {
    const confirmed = await showConfirmation('إعادة ضجميع البيانات', 'هل أنت متأكد من أنك تريد حذف جميع بيانات الموقع؟ لا يمكن التراجع عن هذا الإجراء.');
    if (confirmed) {
      localStorage.removeItem(SKEY);
      sessionStorage.clear();
      state = structuredClone(defaultState);
      applyTheme('dark'); 
      updateLanguage();
      updateBadges(); 
      renderLibrary(); 
      renderLinksList();
      openPage('login');
      showToast('تم مسح جميع البيانات ✅', 'success');
    }
  });

  // ==== Settings Event Listeners ====
  $('#autoCopy').addEventListener('change', ()=>{
    state.settings.autoCopy = $('#autoCopy').checked;
    saveState();
    showToast(translate('settingsSaved'), 'success');
  });
  
  $('#autoSave').addEventListener('change', ()=>{
    state.settings.autoSave = $('#autoSave').checked;
    saveState();
    showToast(translate('settingsSaved'), 'success');
  });
  
  $('#showNotifications').addEventListener('change', ()=>{
    state.settings.showNotifications = $('#showNotifications').checked;
    saveState();
    showToast(translate('settingsSaved'), 'success');
  });
  
  $('#imageQuality').addEventListener('change', ()=>{
    state.settings.imageQuality = $('#imageQuality').value;
    saveState();
    showToast(translate('settingsSaved'), 'success');
  });
  
  $('#focusMode').addEventListener('change', ()=>{
    state.settings.focusMode = $('#focusMode').checked;
    saveState();
    showToast(translate('settingsSaved'), 'success');
  });
  
  $('#animations').addEventListener('change', ()=>{
    state.settings.animations = $('#animations').checked;
    saveState();
    showToast(translate('settingsSaved'), 'success');
  });

  // ==== Analytics ====
  let chart;
  function renderStats(){
    // Update numbers
    updateBadges();
    // Chart
    const ctx = $('#chart');
    const data = {
      labels: [translate('views'), translate('qrGenerations'), translate('downloads'), translate('saves')],
      datasets: [{ 
        label: translate('summary'), 
        data: [state.stats.views, state.stats.generations, state.stats.downloads, state.stats.saves],
        backgroundColor: [
          'rgba(34, 211, 238, 0.7)',
          'rgba(245, 158, 11, 0.7)',
          'rgba(34, 197, 94, 0.7)',
          'rgba(239, 68, 68, 0.7)'
        ]
      }]
    };
    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, { 
      type:'bar', 
      data, 
      options:{ 
        responsive:true, 
        plugins:{ legend:{display:false} },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      } 
    });
    
    renderLibrary();
  }

  // ==== Settings ====
  $('#wipeAll').addEventListener('click', async ()=>{
    const confirmed = await showConfirmation(translate('wipeAllData'), translate('wipeAllDataMessage'));
    if(confirmed){
      localStorage.removeItem(SKEY);
      sessionStorage.clear();
      state = structuredClone(defaultState);
      applyTheme('dark'); 
      updateLanguage();
      updateBadges(); 
      renderLibrary(); 
      renderLinksList();
      openPage('login');
      showToast(translate('wipeAllDataSuccess'), 'success');
    }
  });

  // Restore theme on boot
  applyTheme(state.theme);
  // Restore library grid
  renderLibrary();
  renderLinksList();
</script>
</body>
</html>