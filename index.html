<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Hub Dashboard</title>

<!-- CDNs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --sub:#94a3b8; --ring:#243145;
    --brand:#22d3ee; --accent:#f59e0b; --ok:#22c55e; --bad:#ef4444;
  }
  [data-theme="light"]{
    --bg:#f4f6fb; --card:#ffffff; --text:#0b1220; --sub:#475569; --ring:#e5e7eb;
    --brand:#0ea5e9; --accent:#b45309; --ok:#16a34a; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    background:var(--bg); color:var(--text); transition: background 0.3s, color 0.3s;
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(12px);
    background:linear-gradient(180deg, rgba(0,0,0,.25), transparent);
    border-bottom:1px solid var(--ring);
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .mark {
    width: 36px; height: 36px; border-radius: 10px; 
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    display: flex; align-items: center; justify-content: center;
    position: relative; overflow: hidden;
  }
  .mark::before {
    content: ""; position: absolute; width: 60%; height: 60%;
    background: white; border-radius: 4px; 
    box-shadow: 0 0 0 3px #6a11cb, 0 0 0 5px #2575fc;
  }
  .mark::after {
    content: ""; position: absolute; width: 15%; height: 15%;
    background: #2575fc; border-radius: 50%; bottom: 5px; right: 5px;
  }
  .brand b{font-size:18px}
  .user{opacity:.9}
  nav.tabs{
    display:flex; gap:6px; overflow:auto; padding:8px 12px; border-top:1px solid var(--ring);
  }
  nav.tabs button{
    flex:0 0 auto; padding:10px 12px; border:1px solid var(--ring); background:var(--card);
    color:var(--text); border-radius:12px; cursor:pointer; font-weight:700; transition: all 0.2s;
  }
  nav.tabs button.active{outline:2px solid var(--brand); box-shadow:0 0 0 3px rgba(34,211,238,.15)}
  nav.tabs button:hover{transform: translateY(-2px);}
  .wrap{max-width:1100px; margin-inline:auto; padding:16px}
  .page{display:none; animation:fade .3s ease}
  .page.active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.2); margin-bottom:14px; transition: transform 0.2s;
  }
  .card:hover {transform: translateY(-3px);}
  .row{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px}
  @media (max-width:900px){ .row{grid-template-columns:1fr} }
  label.small{font-size:12px; color:var(--sub); margin:6px 2px; display:block}
  input[type="text"], input[type="url"], input[type="password"], input[type="number"], input[type="color"], textarea, select{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--ring); background:transparent; color:var(--text);
    outline:none; transition: border 0.2s;
  }
  input:focus, textarea:focus, select:focus {border-color: var(--brand);}
  textarea{min-height:80px; resize:vertical}
  .btn{appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; transition: all 0.2s;}
  .btn:hover {transform: translateY(-2px); opacity: 0.9;}
  .btn.primary{background:var(--brand); color:#081018}
  .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--ring)}
  .btn.bad{background:var(--bad); color:#fff}
  .btn.ok{background:var(--ok); color:#fff}
  .stack{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .hint{font-size:12px; color:var(--sub)}
  .center{display:flex; align-items:center; justify-content:center}
  .qrbox{position:relative; display:inline-block; padding:12px; background:#fff; border-radius:16px; margin: 10px 0;}
  .qrbox .logoOverlay{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border-radius:50%; border:3px solid #fff; width:22%; aspect-ratio:1; object-fit:cover}
  .grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px}
  @media (max-width:800px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width:520px){ .grid{grid-template-columns: 1fr; } }
  .thumb{background:#fff; border-radius:12px; padding:8px; border:1px solid var(--ring); transition: transform 0.2s;}
  .thumb:hover {transform: scale(1.02);}
  .thumb img{width:100%; height:auto; display:block; border-radius:8px}
  .flex{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid var(--ring); font-size:12px}
  .alert{padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:rgba(255,255,255,.04)}
  .login-wrap{max-width:420px; margin:40px auto}
  .footer{opacity:.7; text-align:center; font-size:12px; padding:20px}
  
  /* New styles */
  .loading {display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;}
  @keyframes spin {to {transform: rotate(360deg);}}
  .toast {
    position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: var(--card); color: var(--text);
    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center;
    gap: 10px; transform: translateY(100px); opacity: 0; transition: all 0.3s;
  }
  .toast.show {transform: translateY(0); opacity: 1;}
  .toast.success {border-left: 4px solid var(--ok);}
  .toast.error {border-left: 4px solid var(--bad);}
  .toast.info {border-left: 4px solid var(--brand);}
  .modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal.show {opacity: 1; pointer-events: all;}
  .modal-content {
    background: var(--card); padding: 20px; border-radius: 12px; max-width: 400px; width: 90%;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .modal-actions {display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;}
  .social-share {display: flex; gap: 10px; margin-top: 15px;}
  .social-btn {
    display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;
    border-radius: 50%; background: var(--bg); color: var(--text); border: 1px solid var(--ring);
    cursor: pointer; transition: all 0.2s;
  }
  .social-btn:hover {transform: translateY(-3px); background: var(--brand); color: #000;}
  .input-error {border-color: var(--bad) !important;}
  .error-text {color: var(--bad); font-size: 12px; margin-top: 5px;}
  .tab-content {display: none;}
  .tab-content.active {display: block; animation: fade 0.3s;}
  .qr-type-selector {display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
  .qr-type-btn {
    padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--ring);
    cursor: pointer; transition: all 0.2s;
  }
  .qr-type-btn.active {background: var(--brand); color: #000; border-color: var(--brand);}
  .wifi-fields, .contact-fields {display: none;}
  .form-group {margin-bottom: 15px;}
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;
  }
  .stat-card {
    background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--ring);
  }
  .stat-number {
    font-size: 2rem; font-weight: bold; color: var(--brand); margin: 10px 0;
  }
  .stat-label {
    font-size: 0.9rem; color: var(--sub);
  }
  .main-layout {
    display: grid; grid-template-columns: 1fr 350px; gap: 20px;
  }
  @media (max-width: 900px) {
    .main-layout {grid-template-columns: 1fr;}
  }
  .section-title {
    display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 10px;
    border-bottom: 1px solid var(--ring);
  }
  .section-title i {color: var(--brand);}
  .quick-actions {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;
  }
  .lib-item {
    display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px;
    background: var(--card); margin-bottom: 10px; border: 1px solid var(--ring);
  }
  .lib-item img {width: 50px; height: 50px; border-radius: 8px;}
  .lib-info {flex: 1;}
  .lib-actions {display: flex; gap: 5px;}
  .empty-state {
    text-align: center; padding: 30px; color: var(--sub);
  }
  .empty-state i {font-size: 3rem; margin-bottom: 15px; opacity: 0.5;}
  .contact-list {
    list-style: none; padding: 0; margin: 20px 0;
  }
  .contact-list li {
    display: flex; align-items: center; gap: 15px; padding: 12px; 
    border-radius: 10px; background: var(--card); margin-bottom: 10px;
    border: 1px solid var(--ring);
  }
  .contact-list li i {
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: var(--bg); border-radius: 50%; font-size: 18px;
  }
  .contact-list a {
    color: var(--brand); text-decoration: none; transition: all 0.2s;
  }
  .contact-list a:hover {
    text-decoration: underline; color: var(--text);
  }
  .setting-item {
    display: flex; justify-content: space-between; align-items: center; 
    padding: 15px; border-bottom: 1px solid var(--ring);
  }
  .setting-item:last-child {
    border-bottom: none;
  }
  .toggle-switch {
    position: relative; display: inline-block; width: 50px; height: 24px;
  }
  .toggle-switch input {
    opacity: 0; width: 0; height: 0;
  }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--ring); transition: .4s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
  }
  input:checked + .slider {
    background-color: var(--brand);
  }
  input:checked + .slider:before {
    transform: translateX(26px);
  }
  
  /* Link Hub Styles */
  .link-item {
    display: flex; align-items: center; gap: 12px; padding: 12px; 
    border-radius: 12px; background: var(--card); margin-bottom: 10px;
    border: 1px solid var(--ring); transition: all 0.2s;
  }
  .link-item:hover {
    transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .link-icon {
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: var(--bg); border-radius: 10px; font-size: 18px; flex-shrink: 0;
  }
  .link-info {flex: 1;}
  .link-url {
    font-size: 12px; color: var(--sub); overflow: hidden; 
    text-overflow: ellipsis; white-space: nowrap; max-width: 200px;
  }
  .link-actions {display: flex; gap: 5px;}
  .drag-handle {
    cursor: move; color: var(--sub); padding: 5px;
  }
  .theme-options {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;
  }
  .theme-option {
    padding: 15px; border-radius: 12px; text-align: center; cursor: pointer;
    border: 2px solid var(--ring); transition: all 0.2s;
  }
  .theme-option:hover {
    transform: translateY(-3px);
  }
  .theme-option.active {
    border-color: var(--brand); box-shadow: 0 0 0 3px rgba(34,211,238,.15);
  }
  .theme-dark {background: #0b1220; color: #e5e7eb;}
  .theme-light {background: #f4f6fb; color: #0b1220;}
  .theme-auto {background: linear-gradient(135deg, #0b1220 50%, #f4f6fb 50%); color: #0b1220;}
</style>
</head>
<body data-theme="dark">
  <header>
    <div class="topbar wrap">
      <div class="brand">
        <div class="mark"></div>
        <b>QR Hub</b>
      </div>
      <div class="stack">
        <span class="pill user" id="userBadge">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
        <button class="btn ghost" id="toggleTheme" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™/ğŸŒ</button>
        <button class="btn ghost" id="logoutBtn"><i class="fa fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
    <nav class="tabs wrap" id="tabs">
      <button data-page="login" class="active"><i class="fa fa-user"></i> Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button data-page="dashboard"><i class="fa fa-table-columns"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button data-page="qr"><i class="fa fa-qrcode"></i> QR</button>
      <button data-page="links"><i class="fa fa-link"></i> Link Hub</button>
      <button data-page="analytics"><i class="fa fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
      <button data-page="about"><i class="fa fa-users"></i> Ù…Ù† Ù†Ø­Ù†</button>
      <button data-page="settings"><i class="fa fa-gear"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- LOGIN -->
    <section class="page card active" id="login">
      <div class="login-wrap">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p class="hint">Ø¯Ø®Ù‘Ù„ Ø£ÙŠ Ø§Ø³Ù… ÙˆØ¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ù„ØªØ¬Ø±Ø¨Ø©. ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
        <div class="form-group">
          <label class="small">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="l_user" type="text" placeholder="Your name">
        </div>
        <div class="form-group">
          <label class="small">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="l_pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="stack" style="margin-top:10px">
          <button class="btn primary" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn ghost" id="guestBtn">Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</button>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section class="page card" id="dashboard">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</div>
          <div class="stat-number" id="st_views_dash">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ğŸ§© ØªÙˆÙ„ÙŠØ¯ QR</div>
          <div class="stat-number" id="st_generations_dash">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„Ø§Øª</div>
          <div class="stat-number" id="st_downloads_dash">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ğŸ“š Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©</div>
          <div class="stat-number" id="st_saves_dash">0</div>
        </div>
      </div>
      
      <div class="main-layout">
        <div>
          <div class="card">
            <div class="section-title">
              <i class="fa fa-bolt"></i>
              <h3>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
            </div>
            <div class="quick-actions">
              <button class="btn primary" data-jump="qr"><i class="fa fa-qrcode"></i> Ø¥Ù†Ø´Ø§Ø¡ QR</button>
              <button class="btn ghost" data-jump="links"><i class="fa fa-link"></i> Link Hub</button>
              <button class="btn ghost" data-jump="analytics"><i class="fa fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
              <button class="btn ghost" data-jump="settings"><i class="fa fa-gear"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
          </div>
          
          <div class="card">
            <div class="section-title">
              <i class="fa fa-history"></i>
              <h3>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</h3>
            </div>
            <div class="alert" id="lastActivity">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
          </div>
        </div>
        
        <div>
          <div class="card">
            <div class="section-title">
              <i class="fa fa-bookmark"></i>
              <h3>Ø£Ø­Ø¯Ø« QR Ù…Ø­ÙÙˆØ¸</h3>
            </div>
            <div id="recentQrLibrary">
              <div class="empty-state">
                <i class="fa fa-qrcode"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯</p>
                <button class="btn primary" data-jump="qr" style="margin-top: 15px;">Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ QR</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- QR PAGE -->
    <section class="page card" id="qr">
      <h2>Ù…Ù†Ø´Ø¦ QR</h2>
      
      <div class="qr-type-selector">
        <div class="qr-type-btn active" data-type="url">Ø±Ø§Ø¨Ø·</div>
        <div class="qr-type-btn" data-type="wifi">Ø´Ø¨ÙƒØ© WiFi</div>
        <div class="qr-type-btn" data-type="contact">Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„</div>
      </div>
      
      <div class="tab-content active" id="url-fields">
        <div class="row">
          <div>
            <label class="small">Ø§Ù„Ù†Øµ/Ø§Ù„Ø±Ø§Ø¨Ø·</label>
            <input id="qrText" type="url" placeholder="https://example.com Ø£Ùˆ Ø£ÙŠ Ù†Øµ">
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="wifi-fields">
        <div class="row">
          <div>
            <label class="small">Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© (SSID)</label>
            <input id="wifi-ssid" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©">
          </div>
          <div>
            <label class="small">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="wifi-password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± WiFi">
          </div>
          <div>
            <label class="small">Ù†ÙˆØ¹ Ø§Ù„ØªØ´ÙÙŠØ±</label>
            <select id="wifi-encryption">
              <option value="WPA">WPA/WPA2</option>
              <option value="WEP">WEP</option>
              <option value="nopass">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="contact-fields">
        <div class="row">
          <div>
            <label class="small">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="contact-name" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
          </div>
          <div>
            <label class="small">Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input id="contact-phone" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
          </div>
          <div>
            <label class="small">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="contact-email" type="email" placeholder="example@mail.com">
          </div>
          <div>
            <label class="small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="contact-address" type="text" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
          </div>
        </div>
      </div>
      
      <div class="row">
        <div>
          <label class="small">Ø­Ø¬Ù… Ø§Ù„ÙƒÙˆØ¯</label>
          <select id="qrSize">
            <option value="192">192</option>
            <option value="256" selected>256</option>
            <option value="384">384</option>
            <option value="512">512</option>
          </select>
        </div>
        <div>
          <label class="small">Ù„ÙˆÙ† Ø§Ù„Ù†Ù‚Ø§Ø·</label>
          <input id="qrDark" type="color" value="#000000">
        </div>
        <div>
          <label class="small">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
          <input id="qrLight" type="color" value="#ffffff">
        </div>
        <div>
          <label class="small">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØµØ­ÙŠØ­ (ECC)</label>
          <select id="qrECC">
            <option value="L">L</option>
            <option value="M" selected>M</option>
            <option value="Q">Q</option>
            <option value="H">H</option>
          </select>
        </div>
        <div>
          <label class="small">Ø±ÙØ¹ Ù„ÙˆØ¬Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="qrLogo" type="file" accept="image/*">
        </div>
      </div>

      <div class="stack" style="margin:10px 0">
        <button class="btn primary" id="genQR">ØªÙˆÙ„ÙŠØ¯</button>
        <button class="btn ghost" id="dlPNG">ØªØ­Ù…ÙŠÙ„ PNG</button>
        <button class="btn ghost" id="dlPDF">ØªØ­Ù…ÙŠÙ„ PDF</button>
        <button class="btn ok"    id="saveQR">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
        <button class="btn ghost" id="shareQR">Ù…Ø´Ø§Ø±ÙƒØ©</button>
        <button class="btn bad"   id="clearQR">Ù…Ø³Ø­</button>
      </div>

      <div class="center">
        <div id="loadingIndicator" class="loading" style="display:none; margin: 20px;"></div>
        <div class="qrbox">
          <div id="qrcode"></div>
          <img id="qrLogoOverlay" class="logoOverlay" style="display:none" alt="">
        </div>
      </div>
    </section>

    <!-- LINK HUB PAGE -->
    <section class="page card" id="links">
      <h2>Link Hub</h2>
      <p class="hint">Ø£Ø¶Ù ÙˆØ§Ø¯Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø·Ùƒ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯ ÙˆØ£Ù†Ø´Ø¦ QR ÙˆØ§Ø­Ø¯ ÙŠÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø·Ùƒ.</p>
      
      <div class="card">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯</h3>
        <div class="row">
          <div>
            <label class="small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø·</label>
            <input id="linkTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø³Ø§Ø¨ÙŠ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…">
          </div>
          <div>
            <label class="small">Ø§Ù„Ø±Ø§Ø¨Ø·</label>
            <input id="linkUrl" type="url" placeholder="https://example.com">
          </div>
          <div>
            <label class="small">Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="linkIcon">
              <option value="fa-globe">ğŸŒ Ù…ÙˆÙ‚Ø¹</option>
              <option value="fa-instagram">ğŸ“· Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…</option>
              <option value="fa-facebook">ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ</option>
              <option value="fa-twitter">ğŸ¦ ØªÙˆÙŠØªØ±</option>
              <option value="fa-youtube">ğŸ“º ÙŠÙˆØªÙŠÙˆØ¨</option>
              <option value="fa-linkedin">ğŸ’¼ Ù„ÙŠÙ†ÙƒØ¯ Ø¥Ù†</option>
              <option value="fa-github">ğŸ’» Ø¬ÙŠØª Ù‡Ø§Ø¨</option>
              <option value="fa-whatsapp">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</option>
              <option value="fa-envelope">ğŸ“§ Ø¨Ø±ÙŠØ¯</option>
              <option value="fa-phone">ğŸ“ Ù‡Ø§ØªÙ</option>
              <option value="fa-map-marker">ğŸ“ Ù…ÙˆÙ‚Ø¹</option>
              <option value="fa-shopping-bag">ğŸ›’ Ù…ØªØ¬Ø±</option>
            </select>
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <button class="btn primary" id="addLinkBtn">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>
        </div>
      </div>
      
      <div class="card">
        <h3>Ø±ÙˆØ§Ø¨Ø·ÙŠ</h3>
        <p class="hint">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„ØªØºÙŠÙŠØ± ØªØ±ØªÙŠØ¨Ù‡Ø§. Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.</p>
        <div id="linksList"></div>
      </div>
      
      <div class="card">
        <h3>Link Hub QR</h3>
        <p class="hint">Ø£Ù†Ø´Ø¦ QR Code ÙˆØ§Ø­Ø¯ ÙŠÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø·Ùƒ.</p>
        <div class="stack">
          <button class="btn primary" id="genLinkHubQR">Ø¥Ù†Ø´Ø§Ø¡ QR Ù„Ù„Ø±ÙˆØ§Ø¨Ø·</button>
          <button class="btn ghost" id="previewLinkHub">Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
        </div>
        <div class="center" id="linkHubQrContainer" style="margin-top:20px; display:none">
          <div class="qrbox">
            <div id="linkHubQrCode"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section class="page card" id="analytics">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
      <div class="row">
        <div class="card">
          <div class="flex">
            <div>ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</div><b id="st_views">0</b>
          </div>
          <div class="flex">
            <div>ğŸ§© ØªÙˆÙ„ÙŠØ¯ QR</div><b id="st_generations">0</b>
          </div>
          <div class="flex">
            <div>â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„Ø§Øª</div><b id="st_downloads">0</b>
          </div>
          <div class="flex">
            <div>ğŸ“š Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©</div><b id="st_saves">0</b>
          </div>
        </div>
        <div class="card">
          <canvas id="chart" height="150"></canvas>
        </div>
      </div>
      
      <div class="card">
        <h3>ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù€ QR Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
        <div class="grid" id="qrLibrary"></div>
        <div class="stack" style="margin-top:8px">
          <button class="btn bad" id="clearLib">Ù…Ø³Ø­ Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="page card" id="about">
      <h2>Ù…Ù† Ù†Ø­Ù†</h2>
      <div class="alert">
        <p>
          Ø¥Ø­Ù†Ø§ ÙØ±ÙŠÙ‚ ØµØºÙŠØ± Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¯Ù‡ Ø¨Ø´ØºÙ ÙˆØ®Ø·ÙˆØ§Øª ÙƒØªÙŠØ± ÙˆØªØ¬Ø§Ø±Ø¨ Ø£ÙƒØªØ±ØŒ
          Ù‡Ø¯ÙÙ†Ø§ Ù†Ø³Ù‡Ù‘Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§Ø³ ØªÙ†Ø¸ÙŠÙ… Ù‡ÙˆÙŠØªÙ‡Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠØ©: ÙƒÙˆØ¯ ÙˆØ§Ø­Ø¯ ÙŠÙˆØµÙ„ Ù„ÙƒÙ„ Ø±ÙˆØ§Ø¨Ø·ÙƒØŒ
          ÙˆÙ…Ø­ÙØ¸Ø© Ø´Ø®ØµÙŠØ© ØªØ­ÙØ¸ Ù…Ø³ØªÙ†Ø¯Ø§ØªÙƒ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ ÙˆÙ„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØ¯ÙŠÙƒ Ø±Ø¤ÙŠØ© ÙˆØ§Ø¶Ø­Ø©.
        </p>
        <p>
          ØªØ¹Ø¨Ù†Ø§ ÙÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ØªØ¬Ø±Ø¨Ø© Ø¹Ù„Ø´Ø§Ù† Ù†ÙˆØµÙ„ Ù„ØªØ¬Ø±Ø¨Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ Ø³Ø±ÙŠØ¹Ø©ØŒ ÙˆØ´ÙŠØ§ÙƒØ© ØªØ´Ø¨Ù‡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©.
          ÙƒÙ„ Ø¯Ù‡ Ø¨ÙŠØ´ØªØºÙ„ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± â€” Ø§Ø­ØªØ±Ø§Ù…Ù‹Ø§ Ù„Ø®ØµÙˆØµÙŠØªÙƒ ÙˆØ³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….
        </p>
        <p>
          ØªÙ‚Ø¯Ø± ØªØ³ØªÙÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ù‡ÙˆÙŠØªÙƒ ÙˆÙ„ÙŠÙ†ÙƒØ§ØªÙƒØŒ ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ØŒ ÙˆØªØªØ¨Ø¹ Ù†Ø´Ø§Ø·Ùƒ â€” ÙƒÙ„ Ø¯Ù‡ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ.
        </p>
        <h3>Ø·Ø±Ù‚ Ø§Ù„ØªÙˆØ§ØµÙ„:</h3>
        <ul class="contact-list">
          <li>
            <i class="fas fa-envelope" style="color: #ea4335;"></i>
            <div>
              <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</strong><br>
              <a href="mailto:elm3hdy1@gmail.com">elm3hdy1@gmail.com</a>
            </div>
          </li>
          <li>
            <i class="fab fa-whatsapp" style="color: #25d366;"></i>
            <div>
              <strong>ÙˆØ§ØªØ³Ø§Ø¨</strong><br>
              <a href="https://wa.me/201050822701" target="_blank">+201050822701</a>
            </div>
          </li>
          <li>
            <i class="fab fa-facebook" style="color: #1877f2;"></i>
            <div>
              <strong>ÙÙŠØ³Ø¨ÙˆÙƒ</strong><br>
              <a href="https://www.facebook.com/share/19iJ6sLbhq/" target="_blank">facebook.com/QRHub</a>
            </div>
          </li>
          <li>
            <i class="fab fa-instagram" style="color: #e4405f;"></i>
            <div>
              <strong>Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…</strong><br>
              <a href="https://instagram.com/elm3hdy_01" target="_blank">instagram.com/elm3hdy_01</a>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="page card" id="settings">
      <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div class="row">
        <div class="card">
          <h3>Ø§Ù„Ù…Ø¸Ù‡Ø±</h3>
          <div class="theme-options">
            <div class="theme-option theme-dark active" data-theme="dark">
              <i class="fas fa-moon"></i>
              <div>Ø¯Ø§ÙƒÙ†</div>
            </div>
            <div class="theme-option theme-light" data-theme="light">
              <i class="fas fa-sun"></i>
              <div>ÙØ§ØªØ­</div>
            </div>
            <div class="theme-option theme-auto" data-theme="auto">
              <i class="fas fa-adjust"></i>
              <div>ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
            </div>
          </div>
          <p class="hint">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
        </div>
        <div class="card">
          <h3>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
          <div class="stack">
            <button class="btn bad" id="wipeAll">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>
          <p class="hint">ÙŠØ´Ù…Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŒ Ø§Ù„Ù…ÙƒØªØ¨Ø©ØŒ ÙˆØ§Ù„Ù…Ø­ÙØ¸Ø©.</p>
        </div>
      </div>
      
      <div class="card">
        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
        
        <div class="setting-item">
          <div>
            <strong>Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø±Ø§Ø¨Ø·</strong>
            <p class="hint">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ QR</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoCopy">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong>Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</strong>
            <p class="hint">Ø­ÙØ¸ QR ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoSave">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·</strong>
            <p class="hint">Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ø§Ù…</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="showNotifications" checked>
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong>Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±</strong>
            <p class="hint">Ø¬ÙˆØ¯Ø© ØµÙˆØ± QR Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>
          </div>
          <select id="imageQuality">
            <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
            <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
          </select>
        </div>
        
        <div class="setting-item">
          <div>
            <strong>ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²</strong>
            <p class="hint">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="focusMode">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div>
            <strong>Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©</strong>
            <p class="hint">ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="animations" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="card">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
        <div class="setting-item">
          <strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø±</strong>
          <span class="hint">1.3.0</span>
        </div>
        <div class="setting-item">
          <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«</strong>
          <span class="hint">ÙŠÙ†Ø§ÙŠØ± 2025</span>
        </div>
        <div class="setting-item">
          <strong>Ø§Ù„Ù…Ø·ÙˆØ±</strong>
          <span class="hint">Ahmed Elmahdy</span>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">Â© 2025 QR Hub â€” ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±</div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content">
      <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
      <p id="modalMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…ØªØ§Ø¨Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p>
      <div class="modal-actions">
        <button class="btn ghost" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="modalConfirm">ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

  <!-- Link Hub Preview Modal -->
  <div class="modal" id="linkHubPreviewModal">
    <div class="modal-content" style="max-width: 500px;">
      <h3>Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</h3>
      <div id="linkHubPreview" style="max-height: 400px; overflow-y: auto;">
        <!-- Preview content will be inserted here -->
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="closePreview">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

<script>
  // ==== Helpers & Storage ====
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => [...root.querySelectorAll(s)];
  const SKEY = 'qrhub_state_v3';
  const defaultState = {
    theme: 'dark',
    user: null, // {name, passHash, userId}
    stats: { views: 0, generations: 0, downloads: 0, saves: 0 },
    lastActivity: '',
    qrLib: [], // [{id, dataURL, text, createdAt, name}]
    links: [], // [{id, title, url, icon, order}]
    settings: {
      autoCopy: false,
      autoSave: false,
      showNotifications: true,
      imageQuality: 'medium',
      focusMode: false,
      animations: true
    }
  };
  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(SKEY);
      return raw ? {...defaultState, ...JSON.parse(raw)} : structuredClone(defaultState);
    }catch{ return structuredClone(defaultState); }
  }
  
  function saveState(){
    localStorage.setItem(SKEY, JSON.stringify(state));
    updateBadges();
    updateDashboard();
    updateSettingsUI();
    renderLinksList();
  }
  
  function logActivity(msg){
    state.lastActivity = `${new Date().toLocaleString()} â€” ${msg}`;
    $('#lastActivity').textContent = state.lastActivity || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
    saveState();
  }

  // Toast notifications
  function showToast(message, type = 'info', duration = 3000) {
    if (!state.settings.showNotifications) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-info-circle';
    if (type === 'success') icon = 'fa-check-circle';
    if (type === 'error') icon = 'fa-exclamation-circle';
    
    toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
    $('#toastContainer').appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // Confirmation modal
  function showConfirmation(title, message) {
    return new Promise((resolve) => {
      $('#modalTitle').textContent = title;
      $('#modalMessage').textContent = message;
      $('#confirmationModal').classList.add('show');
      
      $('#modalCancel').onclick = () => {
        $('#confirmationModal').classList.remove('show');
        resolve(false);
      };
      
      $('#modalConfirm').onclick = () => {
        $('#confirmationModal').classList.remove('show');
        resolve(true);
      };
    });
  }

  // Theme
  function applyTheme(t){ 
    if (t === 'auto') {
      // Check system preference
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
    } else {
      document.body.setAttribute('data-theme', t);
    }
    state.theme = t; 
    saveState(); 
  }
  
  $('#toggleTheme').addEventListener('click', ()=> {
    const currentTheme = state.theme;
    if (currentTheme === 'dark') applyTheme('light');
    else if (currentTheme === 'light') applyTheme('auto');
    else applyTheme('dark');
  });
  
  $$('#settings [data-theme]').forEach(b => b.addEventListener('click', ()=> applyTheme(b.dataset.theme)));
  $$('.theme-option').forEach(opt => {
    opt.addEventListener('click', () => {
      $$('.theme-option').forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
      applyTheme(opt.dataset.theme);
    });
  });

  // Tabs & Auth
  const tabs = $('#tabs');
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const page = btn.dataset.page;
    if(!page) return;
    if(!state.user && page!=='login'){ showToast('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§', 'error'); return; }
    openPage(page);
  });
  
  function openPage(id){
    $$('#tabs button').forEach(b=> b.classList.toggle('active', b.dataset.page===id));
    $$('.page').forEach(p=> p.classList.toggle('active', p.id===id));
    if(id==='analytics') renderStats();
    if(id==='dashboard') updateDashboard();
    if(id==='settings') updateSettingsUI();
    if(id==='links') renderLinksList();
  }

  function updateBadges(){
    $('#userBadge').textContent = state.user ? `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ${state.user.name}` : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    $('#st_views').textContent = state.stats.views;
    $('#st_generations').textContent = state.stats.generations;
    $('#st_downloads').textContent = state.stats.downloads;
    $('#st_saves').textContent = state.stats.saves;
    $('#lastActivity').textContent = state.lastActivity || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
  }

  function updateDashboard() {
    $('#st_views_dash').textContent = state.stats.views;
    $('#st_generations_dash').textContent = state.stats.generations;
    $('#st_downloads_dash').textContent = state.stats.downloads;
    $('#st_saves_dash').textContent = state.stats.saves;
    $('#lastActivity').textContent = state.lastActivity || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
    
    renderRecentLibrary();
  }

  function updateSettingsUI() {
    $('#autoCopy').checked = state.settings.autoCopy;
    $('#autoSave').checked = state.settings.autoSave;
    $('#showNotifications').checked = state.settings.showNotifications;
    $('#imageQuality').value = state.settings.imageQuality;
    $('#focusMode').checked = state.settings.focusMode;
    $('#animations').checked = state.settings.animations;
    
    // Update theme options active state
    $$('.theme-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.theme === state.theme);
    });
  }

  // Login
  $('#loginBtn').addEventListener('click', ()=>{
    const name = $('#l_user').value.trim();
    const pass = $('#l_pass').value.trim();
    if(!name || !pass) return showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
    
    // Hash password for basic security and create user ID
    const passHash = sha256(pass);
    const userId = sha256(name + Date.now()); // Unique ID for each user
    
    // Check if this is a new user
    state.user = {name, passHash, userId}; 
    saveState();
    logActivity('ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„');
    showToast(`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${name}!`, 'success');
    
    // Hide login page and show dashboard
    $('#login').classList.remove('active');
    openPage('dashboard');
  });
  
  $('#guestBtn').addEventListener('click', ()=>{
    const guestId = 'guest_' + Date.now();
    state.user = {name:'Ø¶ÙŠÙ', passHash: '', userId: guestId}; 
    saveState();
    logActivity('Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ');
    showToast('Ø¯Ø®Ù„Øª ÙƒØ¶ÙŠÙ', 'info');
    
    // Hide login page and show dashboard
    $('#login').classList.remove('active');
    openPage('dashboard');
  });
  
  $('#logoutBtn').addEventListener('click', async ()=>{
    const confirmed = await showConfirmation('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ');
    if (confirmed) {
      state.user = null; 
      saveState(); 
      
      // Show login page and hide others
      openPage('login');
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'info');
    }
  });

  // Increase views on first load of session
  (function incViewsOnce(){
    const k='qrhub_viewed';
    if(!sessionStorage.getItem(k)){ state.stats.views++; sessionStorage.setItem(k,'1'); saveState(); }
  })();

  // Jump buttons from dashboard
  $$('#dashboard [data-jump]').forEach(b=> b.addEventListener('click', ()=> openPage(b.dataset.jump)));

  // Apply saved theme and user
  applyTheme(state.theme);
  updateBadges();
  if(state.user){ 
    $('#login').classList.remove('active');
    openPage('dashboard'); 
  } else { 
    openPage('login'); 
  }

  // QR Type Selector
  $$('.qr-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active button
      $$('.qr-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Show relevant fields
      $$('.tab-content').forEach(tab => tab.classList.remove('active'));
      $(`#${btn.dataset.type}-fields`).classList.add('active');
    });
  });

  // ==== QR Builder ====
  let qrcode = null;
  let logoDataURL = null;

  $('#qrLogo').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const url = await fileToDataURL(f); logoDataURL = url;
    const img = $('#qrLogoOverlay'); img.src = url; img.style.display = 'block';
  });

  $('#genQR').addEventListener('click', async ()=>{
    const type = $('.qr-type-btn.active').dataset.type;
    let text = '';
    
    // Validate and prepare text based on type
    if (type === 'url') {
      text = $('#qrText').value.trim();
      if(!text) return showToast('Ø§ÙƒØªØ¨ Ù†ØµÙ‹Ø§ Ø£Ùˆ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§', 'error');
      if (!text.startsWith('http')) text = 'https://' + text;
    } 
    else if (type === 'wifi') {
      const ssid = $('#wifi-ssid').value.trim();
      const password = $('#wifi-password').value.trim();
      const encryption = $('#wifi-encryption').value;
      
      if (!ssid) return showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©', 'error');
      text = `WIFI:S:${ssid};T:${encryption};P:${password};;`;
    }
    else if (type === 'contact') {
      const name = $('#contact-name').value.trim();
      const phone = $('#contact-phone').value.trim();
      const email = $('#contact-email').value.trim();
      const address = $('#contact-address').value.trim();
      
      if (!name && !phone && !email) return showToast('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
      
      let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
      if (name) vcard += `FN:${name}\n`;
      if (phone) vcard += `TEL:${phone}\n`;
      if (email) vcard += `EMAIL:${email}\n`;
      if (address) vcard += `ADR:;;${address};;;\n`;
      vcard += 'END:VCARD';
      
      text = vcard;
    }
    
    const size = +$('#qrSize').value;
    const dark = $('#qrDark').value; const light = $('#qrLight').value;
    const ecc = {L:QRCode.CorrectLevel.L, M:QRCode.CorrectLevel.M, Q:QRCode.CorrectLevel.Q, H:QRCode.CorrectLevel.H}[$('#qrECC').value] || QRCode.CorrectLevel.M;

    // Show loading
    $('#loadingIndicator').style.display = 'block';
    
    // Small delay to allow UI to update
    await new Promise(resolve => setTimeout(resolve, 10));
    
    $('#qrcode').innerHTML = '';
    qrcode = new QRCode($('#qrcode'), { text, width:size, height:size, colorDark:dark, colorLight:light, correctLevel:ecc });

    // Small delay for canvas render
    setTimeout(()=>{ 
      if(logoDataURL) $('#qrLogoOverlay').style.display='block'; 
      $('#loadingIndicator').style.display = 'none';
      
      // Auto-copy if enabled
      if (state.settings.autoCopy && type === 'url') {
        navigator.clipboard.writeText(text).then(() => {
          showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
        });
      }
      
      // Auto-save if enabled
      if (state.settings.autoSave) {
        setTimeout(() => {
          $('#saveQR').click();
        }, 500);
      }
    }, 200);

    state.stats.generations++; saveState();
    logActivity('ØªÙˆÙ„ÙŠØ¯ QR');
    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ QR Ø¨Ù†Ø¬Ø§Ø­', 'success');
  });

  $('#clearQR').addEventListener('click', ()=>{
    $('#qrcode').innerHTML = ''; 
    $('#qrLogoOverlay').style.display='none'; 
    logoDataURL=null; 
    $('#qrLogo').value='';
    showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù€ QR', 'info');
  });

  $('#dlPNG').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast('Ø§Ø¹Ù…ÙÙ„ QR Ø§Ù„Ø£ÙˆÙ„', 'error');
    const a = document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download='qrcode.png'; a.click();
    state.stats.downloads++; saveState(); logActivity('ØªØ­Ù…ÙŠÙ„ PNG');
    showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', 'success');
  });

  $('#dlPDF').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast('Ø§Ø¹Ù…ÙÙ„ QR Ø§Ù„Ø£ÙˆÙ„', 'error');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text('QR Hub', 10, 10);
    const w = 160, h = 160;
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 20, 20, w, h);
    pdf.save('qrcode.pdf');
    state.stats.downloads++; saveState(); logActivity('ØªØ­Ù…ÙŠÙ„ PDF');
    showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ PDF', 'success');
  });

  $('#shareQR').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast('Ø§Ø¹Ù…ÙÙ„ QR Ø§Ù„Ø£ÙˆÙ„', 'error');
    if(navigator.canShare && canvas.toBlob){
      canvas.toBlob(async blob=>{
        const file = new File([blob], 'qrcode.png', {type:'image/png'});
        try{
          await navigator.share({ files:[file], title:'QR Hub', text:'ÙƒÙˆØ¯ QR Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ' });
          showToast('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }catch(e){
          showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', 'info');
        }
      });
    }else{
      showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Share Ù„Ù„Ù…Ù„ÙØ§Øª â€” Ø§Ø³ØªØ®Ø¯Ù… ØªØ­Ù…ÙŠÙ„ PNG Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.', 'error');
    }
  });

  $('#saveQR').addEventListener('click', async ()=>{
    const canvas = await mergedCanvas();
    if(!canvas) return showToast('Ø§Ø¹Ù…ÙÙ„ QR Ø§Ù„Ø£ÙˆÙ„', 'error');
    
    // Ask for a name for the QR code
    const qrName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ Ù„Ù„Ù€ QR (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', '');
    const text = $('#qrText').value.trim();
    const dataURL = canvas.toDataURL('image/png');
    
    state.qrLib.unshift({ 
      id: Date.now(), 
      dataURL, 
      text, 
      name: qrName || text.substring(0, 20) + (text.length > 20 ? '...' : ''),
      createdAt: new Date().toISOString() 
    });
    
    state.stats.saves++; saveState(); 
    renderLibrary();
    renderRecentLibrary();
    logActivity('Ø­ÙØ¸ QR ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©');
    showToast('ØªÙ… Ø­ÙØ¸ QR ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©', 'success');
  });

  $('#clearLib').addEventListener('click', async ()=>{
    if(!state.qrLib.length) return showToast('Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙØ¹Ù„', 'info');
    
    const confirmed = await showConfirmation('Ù…Ø³Ø­ Ø§Ù„Ù…ÙƒØªØ¨Ø©', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.');
    if(confirmed){ 
      state.qrLib = []; 
      saveState(); 
      renderLibrary(); 
      renderRecentLibrary();
      showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…ÙƒØªØ¨Ø©', 'success');
    }
  });

  function renderLibrary(){
    const host = $('#qrLibrary'); host.innerHTML='';
    if(!state.qrLib.length){ host.innerHTML = '<div class="empty-state"><i class="fa fa-qrcode"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯</p></div>'; return; }
    state.qrLib.forEach(item=>{
      const card = document.createElement('div'); card.className='thumb';
      card.innerHTML = `
        <img src="${item.dataURL}" alt="QR">
        <div class="flex" style="margin-top:8px">
          <small class="hint" title="${item.text || ''}">${item.name || (item.text || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†').slice(0,24)}</small>
          <div class="stack">
            <button class="btn ghost" data-dl="${item.id}">ØªÙ†Ø²ÙŠÙ„</button>
            <button class="btn ghost" data-edit="${item.id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn bad" data-del="${item.id}">Ø­Ø°Ù</button>
          </div>
        </div>`;
      host.appendChild(card);
    });
  }
  
  function renderRecentLibrary() {
    const host = $('#recentQrLibrary'); 
    if(!state.qrLib.length){ 
      host.innerHTML = '<div class="empty-state"><i class="fa fa-qrcode"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯</p><button class="btn primary" data-jump="qr" style="margin-top: 15px;">Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ QR</button></div>'; 
      return; 
    }
    
    host.innerHTML = '';
    // Show only the first 3 items
    const recentItems = state.qrLib.slice(0, 3);
    
    recentItems.forEach(item => {
      const libItem = document.createElement('div');
      libItem.className = 'lib-item';
      libItem.innerHTML = `
        <img src="${item.dataURL}" alt="QR">
        <div class="lib-info">
          <div>${item.name || (item.text || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†').substring(0, 20) + (item.text.length > 20 ? '...' : '')}</div>
          <small class="hint">${new Date(item.createdAt).toLocaleDateString()}</small>
        </div>
        <div class="lib-actions">
          <button class="btn ghost" data-dl="${item.id}"><i class="fa fa-download"></i></button>
          <button class="btn bad" data-del="${item.id}"><i class="fa fa-trash"></i></button>
        </div>
      `;
      host.appendChild(libItem);
    });
    
    if (state.qrLib.length > 3) {
      const viewAll = document.createElement('div');
      viewAll.style.textAlign = 'center';
      viewAll.style.marginTop = '15px';
      viewAll.innerHTML = `<button class="btn ghost" data-jump="analytics">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ (${state.qrLib.length})</button>`;
      host.appendChild(viewAll);
    }
  }
  
  $('#qrLibrary').addEventListener('click', async (e)=>{
    const dl = e.target.closest('[data-dl]'); 
    const edit = e.target.closest('[data-edit]');
    const del = e.target.closest('[data-del]');
    
    if(dl){
      const it = state.qrLib.find(x=> x.id == dl.dataset.dl);
      if(it){ 
        const a=document.createElement('a'); 
        a.href=it.dataURL; 
        a.download='qrcode.png'; 
        a.click(); 
        state.stats.downloads++; 
        saveState(); 
        showToast('ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'success');
      }
    }
    
    if(edit){
      const it = state.qrLib.find(x=> x.id == edit.dataset.dl);
      if(it){
        const newName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', it.name || '');
        if (newName !== null) {
          it.name = newName;
          saveState();
          renderLibrary();
          renderRecentLibrary();
          showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'success');
        }
      }
    }
    
    if(del){
      const confirmed = await showConfirmation('Ø­Ø°Ù QR', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù€ QRØŸ');
      if(confirmed){
        state.qrLib = state.qrLib.filter(x=> x.id != del.dataset.del); 
        saveState(); 
        renderLibrary();
        renderRecentLibrary();
        showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
      }
    }
  });
  
  // Handle clicks in the recent library
  $('#recentQrLibrary').addEventListener('click', async (e)=>{
    const dl = e.target.closest('[data-dl]'); 
    const del = e.target.closest('[data-del]');
    const jump = e.target.closest('[data-jump]');
    
    if(dl){
      const it = state.qrLib.find(x=> x.id == dl.dataset.dl);
      if(it){ 
        const a=document.createElement('a'); 
        a.href=it.dataURL; 
        a.download='qrcode.png'; 
        a.click(); 
        state.stats.downloads++; 
        saveState(); 
        showToast('ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'success');
      }
    }
    
    if(del){
      const confirmed = await showConfirmation('Ø­Ø°Ù QR', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù€ QRØŸ');
      if(confirmed){
        state.qrLib = state.qrLib.filter(x=> x.id != del.dataset.del); 
        saveState(); 
        renderLibrary();
        renderRecentLibrary();
        showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
      }
    }
    
    if(jump){
      openPage(jump.dataset.jump);
    }
  });

  async function mergedCanvas(){
    const baseCanvas = $('#qrcode canvas');
    if(!baseCanvas) return null;
    // if no logo, return the base directly
    if(!logoDataURL){ return baseCanvas; }
    // draw onto offscreen
    const off = document.createElement('canvas');
    off.width = baseCanvas.width; off.height = baseCanvas.height;
    const ctx = off.getContext('2d');
    ctx.drawImage(baseCanvas, 0, 0);
    // draw logo
    const img = await loadImage(logoDataURL);
    const lw = Math.floor(off.width * 0.22);
    const x = Math.floor((off.width - lw)/2), y = Math.floor((off.height - lw)/2);
    // white circle behind
    ctx.save();
    ctx.beginPath(); ctx.arc(off.width/2, off.height/2, lw/2+3, 0, Math.PI*2); ctx.fillStyle = '#fff'; ctx.fill();
    ctx.closePath(); ctx.restore();
    ctx.drawImage(img, x, y, lw, lw);
    return off;
  }

  function loadImage(src){
    return new Promise((res, rej)=>{ const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src = src; });
  }
  function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); }); }

  renderLibrary();
  renderRecentLibrary();

  // ==== Link Hub Functionality ====
  function renderLinksList() {
    const container = $('#linksList');
    container.innerHTML = '';
    
    if (state.links.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fa fa-link"></i>
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ø¨Ø¹Ø¯</p>
          <p class="hint">Ø£Ø¶Ù Ø±ÙˆØ§Ø¨Ø·Ùƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡</p>
        </div>
      `;
      return;
    }
    
    // Sort links by order
    const sortedLinks = [...state.links].sort((a, b) => a.order - b.order);
    
    sortedLinks.forEach(link => {
      const linkItem = document.createElement('div');
      linkItem.className = 'link-item';
      linkItem.dataset.id = link.id;
      linkItem.innerHTML = `
        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
        <div class="link-icon"><i class="fas ${link.icon || 'fa-globe'}"></i></div>
        <div class="link-info">
          <div>${link.title}</div>
          <div class="link-url">${link.url}</div>
        </div>
        <div class="link-actions">
          <button class="btn ghost" data-link-edit="${link.id}"><i class="fa fa-edit"></i></button>
          <button class="btn bad" data-link-delete="${link.id}"><i class="fa fa-trash"></i></button>
        </div>
      `;
      container.appendChild(linkItem);
    });
    
    // Make links draggable for reordering
    initDragAndDrop();
  }
  
  function initDragAndDrop() {
    const container = $('#linksList');
    let draggedItem = null;
    
    $$('.link-item').forEach(item => {
      // Drag start
      item.addEventListener('dragstart', (e) => {
        draggedItem = item;
        setTimeout(() => item.style.opacity = '0.5', 0);
      });
      
      // Drag end
      item.addEventListener('dragend', () => {
        $$('.link-item').forEach(i => i.style.opacity = '1');
        draggedItem = null;
      });
      
      // Drag over
      item.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
      
      // Drag enter
      item.addEventListener('dragenter', (e) => {
        e.preventDefault();
        item.style.backgroundColor = 'var(--ring)';
      });
      
      // Drag leave
      item.addEventListener('dragleave', () => {
        item.style.backgroundColor = '';
      });
      
      // Drop
      item.addEventListener('drop', (e) => {
        e.preventDefault();
        item.style.backgroundColor = '';
        
        if (draggedItem !== item) {
          // Reorder items
          const items = [...container.children];
          const fromIndex = items.indexOf(draggedItem);
          const toIndex = items.indexOf(item);
          
          if (fromIndex < toIndex) {
            container.insertBefore(draggedItem, item.nextSibling);
          } else {
            container.insertBefore(draggedItem, item);
          }
          
          // Update order in state
          const newOrder = [...container.children].map((child, index) => {
            const id = parseInt(child.dataset.id);
            const link = state.links.find(l => l.id === id);
            link.order = index;
            return link;
          });
          
          state.links = newOrder;
          saveState();
          showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·', 'success');
        }
      });
    });
  }
  
  // Add new link
  $('#addLinkBtn').addEventListener('click', () => {
    const title = $('#linkTitle').value.trim();
    const url = $('#linkUrl').value.trim();
    const icon = $('#linkIcon').value;
    
    if (!title || !url) {
      showToast('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ ÙˆØ±Ø§Ø¨Ø·Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§', 'error');
      return;
    }
    
    // Validate URL
    let validUrl = url;
    if (!url.startsWith('http')) {
      validUrl = 'https://' + url;
    }
    
    const newLink = {
      id: Date.now(),
      title,
      url: validUrl,
      icon,
      order: state.links.length
    };
    
    state.links.push(newLink);
    saveState();
    renderLinksList();
    
    // Clear form
    $('#linkTitle').value = '';
    $('#linkUrl').value = '';
    $('#linkIcon').value = 'fa-globe';
    
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­', 'success');
    logActivity('Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯: ' + title);
  });
  
  // Handle link actions (edit and delete)
  $('#linksList').addEventListener('click', (e) => {
    const editBtn = e.target.closest('[data-link-edit]');
    const deleteBtn = e.target.closest('[data-link-delete]');
    
    if (editBtn) {
      const linkId = parseInt(editBtn.dataset.linkEdit);
      const link = state.links.find(l => l.id === linkId);
      
      if (link) {
        const newTitle = prompt('Ø¹Ø¯Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:', link.title);
        if (newTitle !== null) {
          const newUrl = prompt('Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·:', link.url);
          if (newUrl !== null) {
            link.title = newTitle.trim();
            link.url = newUrl.trim();
            saveState();
            renderLinksList();
            showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·', 'success');
          }
        }
      }
    }
    
    if (deleteBtn) {
      const linkId = parseInt(deleteBtn.dataset.linkDelete);
      const link = state.links.find(l => l.id === linkId);
      
      if (link) {
        const confirmed = confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· "${link.title}"ØŸ`);
        if (confirmed) {
          state.links = state.links.filter(l => l.id !== linkId);
          saveState();
          renderLinksList();
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø·', 'success');
        }
      }
    }
  });
  
  // Generate Link Hub QR
  $('#genLinkHubQR').addEventListener('click', () => {
    if (state.links.length === 0) {
      showToast('Ø£Ø¶Ù Ø±ÙˆØ§Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ QR', 'error');
      return;
    }
    
    // Create a simple HTML page with all links
    const linksHtml = state.links.map(link => `
      <div style="margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 10px;">
        <a href="${link.url}" target="_blank" style="text-decoration: none; color: #333;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="font-size: 24px;"><i class="fas ${link.icon || 'fa-globe'}"></i></div>
            <div>
              <div style="font-weight: bold;">${link.title}</div>
              <div style="font-size: 12px; color: #666;">${link.url}</div>
            </div>
          </div>
        </a>
      </div>
    `).join('');
    
    const htmlPage = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ø±ÙˆØ§Ø¨Ø· ${state.user.name}</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <style>
          body { font-family: 'Cairo', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; text-align: center; }
          h1 { color: #333; }
        </style>
      </head>
      <body>
        <h1>Ø±ÙˆØ§Ø¨Ø· ${state.user.name}</h1>
        ${linksHtml}
        <p style="margin-top: 30px; color: #999; font-size: 12px;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… QR Hub</p>
      </body>
      </html>
    `;
    
    // Convert to data URL
    const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(htmlPage)}`;
    
    // Generate QR code
    $('#linkHubQrCode').innerHTML = '';
    new QRCode($('#linkHubQrCode'), { 
      text: dataUrl, 
      width: 256, 
      height: 256,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
    
    $('#linkHubQrContainer').style.display = 'block';
    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ QR Ù„Ù„Ø±ÙˆØ§Ø¨Ø·', 'success');
    logActivity('Ø¥Ù†Ø´Ø§Ø¡ QR Ù„ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·');
  });
  
  // Preview Link Hub page
  $('#previewLinkHub').addEventListener('click', () => {
    if (state.links.length === 0) {
      showToast('Ø£Ø¶Ù Ø±ÙˆØ§Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©', 'error');
      return;
    }
    
    const preview = $('#linkHubPreview');
    preview.innerHTML = '';
    
    // Create preview content
    const previewContent = document.createElement('div');
    previewContent.innerHTML = `
      <h3 style="text-align: center; margin-bottom: 20px;">Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</h3>
      <div style="max-height: 300px; overflow-y: auto;">
        ${state.links.map(link => `
          <div style="margin: 10px 0; padding: 12px; background: var(--card); border-radius: 8px; border: 1px solid var(--ring);">
            <a href="${link.url}" target="_blank" style="text-decoration: none; color: var(--text); display: flex; align-items: center; gap: 10px;">
              <div style="font-size: 20px; width: 30px;"><i class="fas ${link.icon || 'fa-globe'}"></i></div>
              <div style="flex: 1;">
                <div style="font-weight: bold;">${link.title}</div>
                <div style="font-size: 12px; color: var(--sub);">${link.url}</div>
              </div>
            </a>
          </div>
        `).join('')}
      </div>
      <p style="text-align: center; margin-top: 15px; color: var(--sub); font-size: 12px;">
        Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§
      </p>
    `;
    
    preview.appendChild(previewContent);
    $('#linkHubPreviewModal').classList.add('show');
  });
  
  // Close preview modal
  $('#closePreview').addEventListener('click', () => {
    $('#linkHubPreviewModal').classList.remove('show');
  });

  // ==== Settings Event Listeners ====
  $('#autoCopy').addEventListener('change', ()=>{
    state.settings.autoCopy = $('#autoCopy').checked;
    saveState();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  });
  
  $('#autoSave').addEventListener('change', ()=>{
    state.settings.autoSave = $('#autoSave').checked;
    saveState();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  });
  
  $('#showNotifications').addEventListener('change', ()=>{
    state.settings.showNotifications = $('#showNotifications').checked;
    saveState();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  });
  
  $('#imageQuality').addEventListener('change', ()=>{
    state.settings.imageQuality = $('#imageQuality').value;
    saveState();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  });
  
  $('#focusMode').addEventListener('change', ()=>{
    state.settings.focusMode = $('#focusMode').checked;
    saveState();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  });
  
  $('#animations').addEventListener('change', ()=>{
    state.settings.animations = $('#animations').checked;
    saveState();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  });

  // ==== Analytics ====
  let chart;
  function renderStats(){
    // Update numbers
    updateBadges();
    // Chart
    const ctx = $('#chart');
    const data = {
      labels: ['Ù…Ø´Ø§Ù‡Ø¯Ø§Øª','ØªÙˆÙ„ÙŠØ¯ QR','ØªÙ†Ø²ÙŠÙ„Ø§Øª','Ø­ÙØ¸ Ù„Ù„Ù…ÙƒØªØ¨Ø©'],
      datasets: [{ 
        label: 'Ù…Ù„Ø®Øµ', 
        data: [state.stats.views, state.stats.generations, state.stats.downloads, state.stats.saves],
        backgroundColor: [
          'rgba(34, 211, 238, 0.7)',
          'rgba(245, 158, 11, 0.7)',
          'rgba(34, 197, 94, 0.7)',
          'rgba(239, 68, 68, 0.7)'
        ]
      }]
    };
    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, { 
      type:'bar', 
      data, 
      options:{ 
        responsive:true, 
        plugins:{ legend:{display:false} },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      } 
    });
    
    renderLibrary();
  }

  // ==== Settings ====
  $('#wipeAll').addEventListener('click', async ()=>{
    const confirmed = await showConfirmation('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª QR Hub Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.');
    if(confirmed){
      localStorage.removeItem(SKEY);
      sessionStorage.clear();
      state = structuredClone(defaultState);
      applyTheme('dark'); updateBadges(); renderLibrary(); renderRecentLibrary(); renderLinksList();
      openPage('login');
      showToast('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…', 'success');
    }
  });

  // Restore theme on boot
  applyTheme(state.theme);
  // Restore library grid
  renderLibrary();
  renderRecentLibrary();
  renderLinksList();
</script>
</body>
</html>